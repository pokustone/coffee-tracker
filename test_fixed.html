<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#d97706">
  <title>Coffee Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, doc, getDoc, setDoc, getDocs, query } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyA0jwdsajnjCHkTh0thPMgsJXyP3XE61CI",
      authDomain: "my-coffee-tracker-7704e.firebaseapp.com",
      projectId: "my-coffee-tracker-7704e",
      storageBucket: "my-coffee-tracker-7704e.firebasestorage.app",
      messagingSenderId: "217300709501",
      appId: "1:217300709501:web:3ccc93a3ae8837713e8114",
      measurementId: "G-F1M0FQ951H"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const BANK_ACCOUNT = "123456789/0100";

    window.storage = {
      async get(key) {
        const docRef = doc(db, 'storage', key);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) return { key, value: docSnap.data().value };
        throw new Error('Not found');
      },
      async set(key, value) {
        await setDoc(doc(db, 'storage', key), { value, updated: new Date().toISOString() });
        return { key, value };
      },
      async list(prefix) {
        const q = query(collection(db, 'storage'));
        const snap = await getDocs(q);
        const keys = [];
        snap.forEach(d => { if (d.id.startsWith(prefix || '')) keys.push(d.id); });
        return { keys };
      }
    };

    class CoffeeApp {
      constructor() {
        this.state = {
          view: 'login',
          userId: null,
          userName: '',
          userEmail: '',
          coffeeCount: 0,
          monthlyTotal: 0,
          coffeePrice: 15,
          coffeeName: '',
          isAdmin: false,
          allUsers: [],
          allTimeLogs: [],
          monthlyLogs: [],
          loginEmail: '',
          loginPassword: '',
          newUserName: '',
          newUserEmail: '',
          newUserPassword: '',
          newPrice: '15',
          newCoffeeName: '',
          customCount: '',
          expandedYears: new Set(),
          expandedMonths: new Set(),
          expandedWeeks: new Set(),
          isLoggingIn: false
        };
      }

      getCurrentMonth() {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
      }

      isFirstDay() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('testFirstDay') === 'true') {
          return true;
        }
        return new Date().getDate() === 1;
      }

      formatDate(ts) {
        return new Date(ts).toLocaleString('cs-CZ', {
          day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
        });
      }

      formatDateShort(ts) {
        return new Date(ts).toLocaleDateString('cs-CZ', {
          day: '2-digit', month: '2-digit', year: 'numeric'
        });
      }

      getWeekNumber(date) {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 4 - (d.getDay() || 7));
        const yearStart = new Date(d.getFullYear(), 0, 1);
        const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return weekNo;
      }

      groupLogsByHierarchy(logs) {
        const grouped = {};
        
        logs.forEach(log => {
          const date = new Date(log.timestamp);
          const year = date.getFullYear();
          const month = `${year}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          const week = `${year}-W${String(this.getWeekNumber(date)).padStart(2, '0')}`;
          const day = date.toISOString().split('T')[0];

          if (!grouped[year]) grouped[year] = { months: {}, total: 0, count: 0 };
          if (!grouped[year].months[month]) grouped[year].months[month] = { weeks: {}, total: 0, count: 0 };
          if (!grouped[year].months[month].weeks[week]) grouped[year].months[month].weeks[week] = { days: {}, total: 0, count: 0 };
          if (!grouped[year].months[month].weeks[week].days[day]) grouped[year].months[month].weeks[week].days[day] = { logs: [], total: 0, count: 0 };

          grouped[year].months[month].weeks[week].days[day].logs.push(log);
          grouped[year].months[month].weeks[week].days[day].total += log.count * log.price;
          grouped[year].months[month].weeks[week].days[day].count += log.count;

          grouped[year].months[month].weeks[week].total += log.count * log.price;
          grouped[year].months[month].weeks[week].count += log.count;

          grouped[year].months[month].total += log.count * log.price;
          grouped[year].months[month].count += log.count;

          grouped[year].total += log.count * log.price;
          grouped[year].count += log.count;
        });

        return grouped;
      }

      async init() {
        try {
          const pr = await storage.get('coffee:global:price');
          const data = JSON.parse(pr.value);
          this.state.coffeePrice = data.price;
          this.state.coffeeName = data.name || '';
          this.state.newPrice = data.price.toString();
          this.state.newCoffeeName = data.name || '';
        } catch (e) {
          await storage.set('coffee:global:price', JSON.stringify({ price: 15, name: '' }));
        }

        this.render();
      }

      async userLogin() {
        if (this.state.isLoggingIn) return;
        
        console.log('üîê Pokus o p≈ôihl√°≈°en√≠:', this.state.loginEmail);
        this.state.isLoggingIn = true;
        
        try {
          const userCredential = await signInWithEmailAndPassword(auth, this.state.loginEmail, this.state.loginPassword);
          console.log('‚úÖ P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©!');
          console.log('üë§ User email:', userCredential.user.email);
          console.log('üîë User UID:', userCredential.user.uid);
          
          // Naƒçti data u≈æivatele
          this.state.userId = userCredential.user.uid;
          this.state.userEmail = userCredential.user.email;
          
          // Naƒçti u≈æivatelsk√° data (vƒçetnƒõ kontroly isAdmin)
          await this.loadUserData(userCredential.user.uid);
          
          console.log('üëë Je admin?', this.state.isAdmin);
          
          // P≈ôepni na main view
          this.state.view = 'main';
          console.log('‚úÖ P≈ôep√≠n√°m na main view');
          this.render();
          
        } catch (error) {
          console.error('‚ùå Login error:', error);
          if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
            alert('≈†patn√Ω email nebo heslo!');
          } else if (error.code === 'auth/invalid-email') {
            alert('Neplatn√Ω email!');
          } else if (error.code === 'auth/too-many-requests') {
            alert('P≈ô√≠li≈° mnoho pokus≈Ø. Zkuste to pozdƒõji.');
          } else if (error.code === 'auth/invalid-credential') {
            alert('Neplatn√© p≈ôihla≈°ovac√≠ √∫daje!');
          } else {
            alert('Chyba p≈ôihl√°≈°en√≠: ' + error.message);
          }
        } finally {
          this.state.isLoggingIn = false;
        }
      }

      async logout() {
        try {
          await signOut(auth);
          this.state.userId = null;
          this.state.userName = '';
          this.state.userEmail = '';
          this.state.isAdmin = false;
          this.state.view = 'login';
          this.render();
        } catch (error) {
          console.error('Logout error:', error);
        }
      }

      async loadUserData(uid) {
        const month = this.getCurrentMonth();
        
        try {
          const userProfile = await storage.get(`user:${uid}`);
          const userData = JSON.parse(userProfile.value);
          this.state.userName = userData.name;
          this.state.isAdmin = userData.isAdmin === true;
        } catch (e) {
          console.warn('‚ö†Ô∏è Nepoda≈ôilo se naƒç√≠st profil:', e);
          this.state.userName = this.state.userEmail.split('@')[0];
          this.state.isAdmin = false;
        }

        try {
          const m = await storage.get(`coffee:${uid}:${month}`);
          this.state.monthlyTotal = JSON.parse(m.value).total || 0;
        } catch (e) { this.state.monthlyTotal = 0; }

        try {
          const t = await storage.get(`coffee:${uid}:total`);
          this.state.coffeeCount = JSON.parse(t.value).count || 0;
        } catch (e) { this.state.coffeeCount = 0; }

        try {
          const l = await storage.get(`coffee:${uid}:logs`);
          const logs = JSON.parse(l.value);
          this.state.allTimeLogs = logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          this.state.monthlyLogs = logs.filter(log => log.month === month).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        } catch (e) {
          this.state.allTimeLogs = [];
          this.state.monthlyLogs = [];
        }

        if (this.state.isAdmin) await this.loadUsers();
      }

      async loadUsers() {
        const keys = await storage.list('user:');
        const users = [];
        const month = this.getCurrentMonth();
        
        for (const k of keys.keys) {
          try {
            const uid = k.replace('user:', '');
            const u = await storage.get(k);
            const userData = JSON.parse(u.value);
            
            const m = await storage.get(`coffee:${uid}:${month}`).catch(() => ({ value: '{"total":0}' }));
            const t = await storage.get(`coffee:${uid}:total`).catch(() => ({ value: '{"count":0}' }));
            
            users.push({
              uid: uid,
              name: userData.name,
              email: userData.email,
              monthlyTotal: JSON.parse(m.value).total || 0,
              allTimeCount: JSON.parse(t.value).count || 0
            });
          } catch (e) { }
        }
        this.state.allUsers = users.sort((a, b) => b.monthlyTotal - a.monthlyTotal);
      }

      async addCoffee(count) {
        if (this.isFirstDay() && this.state.monthlyTotal > 0) {
          alert('Nejprve potvrƒè platbu!');
          return;
        }

        const month = this.getCurrentMonth();
        const logs = this.state.allTimeLogs;
        logs.push({
          count, price: this.state.coffeePrice, coffeeName: this.state.coffeeName,
          timestamp: new Date().toISOString(), month
        });

        await storage.set(`coffee:${this.state.userId}:logs`, JSON.stringify(logs));
        await storage.set(`coffee:${this.state.userId}:${month}`, JSON.stringify({
          total: this.state.monthlyTotal + count, userName: this.state.userName
        }));
        await storage.set(`coffee:${this.state.userId}:total`, JSON.stringify({
          count: this.state.coffeeCount + count
        }));

        this.state.monthlyTotal += count;
        this.state.coffeeCount += count;
        this.state.allTimeLogs = logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        this.state.monthlyLogs = logs.filter(l => l.month === month).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        this.render();
      }

      async confirmPayment() {
        if (this.state.monthlyTotal === 0) {
          alert('Nem√°≈° ≈æ√°dnou k√°vu k zaplacen√≠!');
          return;
        }

        const amount = this.state.monthlyTotal * this.state.coffeePrice;
        const month = this.getCurrentMonth();
        const vs = `${this.state.userId.slice(0, 8)}${month.replace('-', '')}`;

        if (confirm(`Zaplatit ${amount} Kƒç za ${this.state.monthlyTotal} k√°v?\n\nƒå√≠slo √∫ƒçtu: ${BANK_ACCOUNT}\nVariabiln√≠ symbol: ${vs}\n\nPo potvrzen√≠ se ti zobraz√≠ QR k√≥d pro platbu.`)) {
          const paymentData = {
            timestamp: new Date().toISOString(),
            amount: amount,
            count: this.state.monthlyTotal,
            month: month,
            vs: vs,
            status: 'pending'
          };

          await storage.set(`coffee:${this.state.userId}:payment:${month}`, JSON.stringify(paymentData));

          const qrUrl = `https://api.paylibo.com/paylibo/generator/czech/image?accountNumber=${BANK_ACCOUNT}&amount=${amount}&vs=${vs}&size=300`;
          
          const win = window.open('', '_blank');
          win.document.write(`
            <html>
              <head><title>QR k√≥d pro platbu</title></head>
              <body style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;font-family:sans-serif;padding:20px;">
                <h2>Naskenuj QR k√≥d pro platbu</h2>
                <img src="${qrUrl}" alt="QR k√≥d" style="margin:20px;">
                <div style="text-align:center;">
                  <p><strong>ƒå√°stka:</strong> ${amount} Kƒç</p>
                  <p><strong>√öƒçet:</strong> ${BANK_ACCOUNT}</p>
                  <p><strong>Variabiln√≠ symbol:</strong> ${vs}</p>
                </div>
                <button onclick="window.close()" style="margin-top:20px;padding:10px 20px;font-size:16px;cursor:pointer;">Zav≈ô√≠t</button>
              </body>
            </html>
          `);

          this.state.monthlyTotal = 0;
          await storage.set(`coffee:${this.state.userId}:${month}`, JSON.stringify({
            total: 0, userName: this.state.userName
          }));

          this.render();
        }
      }

      async updatePrice() {
        const newPrice = parseFloat(this.state.newPrice);
        const newName = this.state.newCoffeeName.trim();

        if (isNaN(newPrice) || newPrice <= 0) {
          alert('Zadej platnou cenu!');
          return;
        }

        await storage.set('coffee:global:price', JSON.stringify({ price: newPrice, name: newName }));
        this.state.coffeePrice = newPrice;
        this.state.coffeeName = newName;
        alert('Cena k√°vy aktualizov√°na!');
        this.render();
      }

      async createUser() {
        const name = this.state.newUserName.trim();
        const email = this.state.newUserEmail.trim();
        const password = this.state.newUserPassword.trim();

        if (!name || !email || !password) {
          alert('Vypl≈à v≈°echna pole!');
          return;
        }

        const uid = prompt('Vytvo≈ô u≈æivatele v Firebase Console a vlo≈æ sem jeho UID:');
        if (!uid) return;

        try {
          await storage.set(`user:${uid}`, JSON.stringify({
            name, email, isAdmin: false, created: new Date().toISOString()
          }));
          
          alert(`U≈æivatel ${name} vytvo≈ôen!\n\nU≈æiv. jm√©no: ${email}\nHeslo: ${password}\n\nTento u≈æivatel nyn√≠ m≈Ø≈æe pou≈æ√≠t tyto p≈ôihla≈°ovac√≠ √∫daje.`);
          
          this.state.newUserName = '';
          this.state.newUserEmail = '';
          this.state.newUserPassword = '';
          await this.loadUsers();
          this.render();
        } catch (error) {
          alert('Chyba p≈ôi vytv√°≈ôen√≠ u≈æivatele: ' + error.message);
        }
      }

      toggleYear(year) {
        if (this.state.expandedYears.has(year)) {
          this.state.expandedYears.delete(year);
        } else {
          this.state.expandedYears.add(year);
        }
        this.render();
      }

      toggleMonth(month) {
        if (this.state.expandedMonths.has(month)) {
          this.state.expandedMonths.delete(month);
        } else {
          this.state.expandedMonths.add(month);
        }
        this.render();
      }

      toggleWeek(week) {
        if (this.state.expandedWeeks.has(week)) {
          this.state.expandedWeeks.delete(week);
        } else {
          this.state.expandedWeeks.add(week);
        }
        this.render();
      }

      render() {
        const app = document.getElementById('app');
        if (!app) return;

        let html = '';
        if (this.state.view === 'login') html = this.renderLogin();
        else if (this.state.view === 'main') html = this.renderMain();
        else if (this.state.view === 'alltimelog') html = this.renderAllTimeLog();
        else if (this.state.view === 'monthlylog') html = this.renderMonthlyLog();
        else if (this.state.view === 'admin') html = this.renderAdmin();

        app.innerHTML = html;
        this.attachListeners();
      }

      renderLogin() {
        return `
          <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 flex items-center justify-center p-4">
            <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md">
              <div class="text-center mb-8">
                <div class="text-6xl mb-4">‚òï</div>
                <h1 class="text-3xl font-bold text-gray-800">Coffee Tracker</h1>
                <p class="text-gray-600 mt-2">P≈ôihla≈° se</p>
              </div>
              <div class="space-y-4">
                <input
                  type="email"
                  id="loginEmail"
                  value="${this.state.loginEmail}"
                  placeholder="Email"
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-lg outline-none focus:border-amber-500 transition"
                  ${this.state.isLoggingIn ? 'disabled' : ''}
                >
                <input
                  type="password"
                  id="loginPassword"
                  value="${this.state.loginPassword}"
                  placeholder="Heslo"
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-lg outline-none focus:border-amber-500 transition"
                  ${this.state.isLoggingIn ? 'disabled' : ''}
                >
                <button
                  id="loginBtn"
                  class="w-full bg-amber-600 text-white py-3 rounded-xl font-semibold text-lg hover:bg-amber-700 transition disabled:opacity-50"
                  ${this.state.isLoggingIn ? 'disabled' : ''}
                >
                  ${this.state.isLoggingIn ? 'P≈ôihla≈°ov√°n√≠...' : 'P≈ôihl√°sit'}
                </button>
              </div>
            </div>
          </div>
        `;
      }

      renderMain() {
        const s = this.state;
        return `
          <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100">
            <div class="bg-white shadow-md">
              <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                <div>
                  <h1 class="text-xl font-bold">${s.userName}</h1>
                  <p class="text-sm text-gray-600">${s.userEmail}</p>
                </div>
                <div class="flex gap-2">
                  ${s.isAdmin ? '<button id="adminBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700">Admin</button>' : ''}
                  <button id="logoutBtn" class="px-4 py-2 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700">Odhl√°sit</button>
                </div>
              </div>
            </div>
            
            <div class="max-w-4xl mx-auto p-4 space-y-4">
              <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                  <h2 class="text-lg font-bold">Aktu√°ln√≠ k√°va</h2>
                  <div class="text-right">
                    <p class="text-2xl font-bold text-amber-600">${s.coffeePrice} Kƒç</p>
                    ${s.coffeeName ? `<p class="text-sm text-gray-600">‚òï ${s.coffeeName}</p>` : ''}
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div class="bg-white rounded-2xl shadow-lg p-6 text-center cursor-pointer hover:shadow-xl transition" id="allLog">
                  <div class="text-4xl mb-2">üìä</div>
                  <p class="text-sm text-gray-600">Celkem</p>
                  <p class="text-3xl font-bold text-gray-800">${s.coffeeCount}</p>
                  <p class="text-sm text-gray-500">k√°v</p>
                </div>
                
                <div class="bg-white rounded-2xl shadow-lg p-6 text-center cursor-pointer hover:shadow-xl transition" id="monthLog">
                  <div class="text-4xl mb-2">üìÖ</div>
                  <p class="text-sm text-gray-600">Tento mƒõs√≠c</p>
                  <p class="text-3xl font-bold text-amber-600">${s.monthlyTotal}</p>
                  <p class="text-sm text-gray-500">${s.monthlyTotal * s.coffeePrice} Kƒç</p>
                </div>
              </div>

              ${this.isFirstDay() && s.monthlyTotal > 0 ? `
                <div class="bg-red-50 border-2 border-red-200 rounded-2xl p-4">
                  <p class="text-red-800 font-bold mb-2">‚ö†Ô∏è Potvrƒè platbu za minul√Ω mƒõs√≠c!</p>
                  <p class="text-red-700 text-sm mb-3">Nem≈Ø≈æe≈° p≈ôidat k√°vy, dokud nezaplat√≠≈° ${s.monthlyTotal * s.coffeePrice} Kƒç</p>
                  <button id="payBtn" class="w-full bg-red-600 text-white py-3 rounded-xl font-semibold hover:bg-red-700">
                    Zaplatit ${s.monthlyTotal * s.coffeePrice} Kƒç
                  </button>
                </div>
              ` : ''}

              <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-lg font-bold mb-4">P≈ôidat k√°vu</h2>
                <div class="grid grid-cols-2 gap-3 mb-3">
                  <button id="add1" class="bg-amber-500 text-white py-4 rounded-xl font-bold text-xl hover:bg-amber-600 transition">
                    +1 ‚òï
                  </button>
                  <button id="add2" class="bg-amber-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-amber-700 transition">
                    +2 ‚òï‚òï
                  </button>
                </div>
                <div class="flex gap-3">
                  <input
                    type="number"
                    id="custom"
                    placeholder="Vlastn√≠ poƒçet"
                    min="1"
                    class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl text-lg outline-none focus:border-amber-500"
                  >
                  <button id="addCustom" class="px-6 bg-amber-700 text-white rounded-xl font-semibold hover:bg-amber-800 transition">
                    ‚ûï
                  </button>
                </div>
              </div>

              ${s.monthlyTotal > 0 && !this.isFirstDay() ? `
                <div class="bg-white rounded-2xl shadow-lg p-6">
                  <button id="payBtn" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-green-700 transition">
                    üí≥ Zaplatit ${s.monthlyTotal * s.coffeePrice} Kƒç (${s.monthlyTotal} k√°v)
                  </button>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }

      renderAllTimeLog() {
        const s = this.state;
        const grouped = this.groupLogsByHierarchy(s.allTimeLogs);
        const years = Object.keys(grouped).sort((a, b) => b - a);

        return `
          <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100">
            <div class="bg-white shadow-md">
              <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                  <button id="back" class="text-gray-600 hover:text-gray-800">‚óÄÔ∏è</button>
                  <h1 class="text-xl font-bold">V≈°echny z√°znamy</h1>
                </div>
                <div class="text-right">
                  <p class="font-bold text-xl">${s.coffeeCount} k√°v</p>
                  <p class="text-sm text-gray-600">${s.allTimeLogs.reduce((sum, log) => sum + (log.count * log.price), 0)} Kƒç celkem</p>
                </div>
              </div>
            </div>
            <div class="max-w-4xl mx-auto p-4">
              <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                ${years.length > 0 ? years.map(year => {
                  const yearData = grouped[year];
                  const isYearExpanded = s.expandedYears.has(year);
                  const months = Object.keys(yearData.months).sort().reverse();
                  
                  return `
                    <div class="border-b last:border-b-0">
                      <button data-toggle-year="${year}" class="w-full px-6 py-4 flex justify-between items-center hover:bg-gray-50 transition">
                        <div class="flex items-center gap-3">
                          <span class="text-2xl">${isYearExpanded ? 'üìÇ' : 'üìÅ'}</span>
                          <span class="font-bold text-lg">${year}</span>
                        </div>
                        <div class="text-right">
                          <p class="font-bold">${yearData.count} k√°v</p>
                          <p class="text-sm text-amber-600">${yearData.total} Kƒç</p>
                        </div>
                      </button>
                      ${isYearExpanded ? `
                        <div class="pl-6 bg-gray-50">
                          ${months.map(month => {
                            const monthData = yearData.months[month];
                            const isMonthExpanded = s.expandedMonths.has(month);
                            const weeks = Object.keys(monthData.weeks).sort().reverse();
                            const monthName = new Date(month + '-01').toLocaleDateString('cs-CZ', { month: 'long', year: 'numeric' });
                            
                            return `
                              <div class="border-t">
                                <button data-toggle-month="${month}" class="w-full px-6 py-3 flex justify-between items-center hover:bg-gray-100 transition">
                                  <div class="flex items-center gap-3">
                                    <span class="text-xl">${isMonthExpanded ? 'üìÇ' : 'üìÅ'}</span>
                                    <span class="font-semibold capitalize">${monthName}</span>
                                  </div>
                                  <div class="text-right">
                                    <p class="font-bold">${monthData.count} k√°v</p>
                                    <p class="text-sm text-amber-600">${monthData.total} Kƒç</p>
                                  </div>
                                </button>
                                ${isMonthExpanded ? `
                                  <div class="pl-6 bg-white">
                                    ${weeks.map(week => {
                                      const weekData = monthData.weeks[week];
                                      const isWeekExpanded = s.expandedWeeks.has(week);
                                      const days = Object.keys(weekData.days).sort().reverse();
                                      
                                      return `
                                        <div class="border-t">
                                          <button data-toggle-week="${week}" class="w-full px-6 py-3 flex justify-between items-center hover:bg-gray-50 transition">
                                            <div class="flex items-center gap-3">
                                              <span>${isWeekExpanded ? 'üìÇ' : 'üìÅ'}</span>
                                              <span class="font-medium">T√Ωden ${week.split('-W')[1]}</span>
                                            </div>
                                            <div class="text-right">
                                              <p class="font-bold">${weekData.count} k√°v</p>
                                              <p class="text-sm text-amber-600">${weekData.total} Kƒç</p>
                                            </div>
                                          </button>
                                          ${isWeekExpanded ? `
                                            <div class="pl-6">
                                              ${days.map(day => {
                                                const dayData = weekData.days[day];
                                                const dayName = new Date(day).toLocaleDateString('cs-CZ', { weekday: 'long', day: 'numeric', month: 'long' });
                                                
                                                return `
                                                  <div class="border-t py-3 px-6">
                                                    <div class="font-medium mb-2 capitalize">${dayName}</div>
                                                    <div class="space-y-2">
                                                      ${dayData.logs.map(log => `
                                                        <div class="flex justify-between items-center bg-amber-50 rounded-lg p-3">
                                                          <div>
                                                            <p class="font-semibold">${log.count}x k√°va</p>
                                                            ${log.coffeeName ? `<p class="text-sm text-amber-600">‚òï ${log.coffeeName}</p>` : ''}
                                                            <p class="text-sm text-gray-600">${this.formatDate(log.timestamp)}</p>
                                                          </div>
                                                          <div class="text-right">
                                                            <p class="font-bold text-amber-600">${log.count * log.price} Kƒç</p>
                                                            <p class="text-xs text-gray-500">${log.price} Kƒç/ks</p>
                                                          </div>
                                                        </div>
                                                      `).join('')}
                                                    </div>
                                                    <div class="mt-2 pt-2 border-t flex justify-between text-sm">
                                                      <span class="font-semibold">Den celkem:</span>
                                                      <span class="font-bold text-amber-600">${dayData.count} k√°v ‚Ä¢ ${dayData.total} Kƒç</span>
                                                    </div>
                                                  </div>
                                                `;
                                              }).join('')}
                                            </div>
                                          ` : ''}
                                        </div>
                                      `;
                                    }).join('')}
                                  </div>
                                ` : ''}
                              </div>
                            `;
                          }).join('')}
                        </div>
                      ` : ''}
                    </div>
                  `;
                }).join('') : '<p class="text-gray-500 text-center py-8">≈Ω√°dn√© z√°znamy</p>'}
              </div>
            </div>
          </div>
        `;
      }

      renderMonthlyLog() {
        const s = this.state;
        return `
          <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100">
            <div class="bg-white shadow-md">
              <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                  <button id="back" class="text-gray-600 hover:text-gray-800">‚óÄÔ∏è</button>
                  <h1 class="text-xl font-bold">Tento mƒõs√≠c</h1>
                </div>
                <div class="text-right">
                  <p class="font-bold text-xl">${s.monthlyTotal} k√°v</p>
                  <p class="text-sm text-gray-600">${s.monthlyTotal * s.coffeePrice} Kƒç</p>
                </div>
              </div>
            </div>
            <div class="max-w-4xl mx-auto p-4">
              <div class="bg-white rounded-2xl shadow-lg p-6">
                ${s.monthlyLogs.length > 0 ? `<div class="space-y-3">${s.monthlyLogs.map(log => `
                  <div class="flex justify-between items-center bg-amber-50 rounded-lg p-4">
                    <div>
                      <p class="font-semibold">${log.count}x k√°va</p>
                      ${log.coffeeName ? `<p class="text-sm text-amber-600">‚òï ${log.coffeeName}</p>` : ''}
                      <p class="text-sm text-gray-600">${this.formatDate(log.timestamp)}</p>
                    </div>
                    <div class="text-right">
                      <p class="font-bold text-amber-600">${log.count * log.price} Kƒç</p>
                      <p class="text-xs text-gray-500">${log.price} Kƒç/ks</p>
                    </div>
                  </div>
                `).join('')}</div>` : '<p class="text-gray-500 text-center py-8">≈Ω√°dn√© z√°znamy tento mƒõs√≠c</p>'}
              </div>
            </div>
          </div>
        `;
      }

      renderAdmin() {
        const s = this.state;
        return `
          <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100">
            <div class="bg-white shadow-md">
              <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                  <button id="back" class="text-gray-600 hover:text-gray-800">‚óÄÔ∏è</button>
                  <h1 class="text-xl font-bold">Admin</h1>
                </div>
              </div>
            </div>
            <div class="max-w-4xl mx-auto p-4 space-y-4">
              <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-lg font-bold mb-4">Nastaven√≠ k√°vy</h2>
                <div class="mb-4">
                  <label class="block text-sm font-semibold mb-2">N√°zev</label>
                  <input type="text" id="newName" value="${s.newCoffeeName}" placeholder="Ethiopia..." 
                    class="w-full px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500">
                  <p class="text-xs text-gray-500 mt-1">Aktu√°ln√≠: ${s.coffeeName || 'Bez n√°zvu'}</p>
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-semibold mb-2">Cena</label>
                  <div class="flex gap-3">
                    <input type="number" id="newPrice" value="${s.newPrice}" 
                      class="flex-1 px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500">
                    <div class="flex items-center px-4 font-semibold">Kƒç</div>
                  </div>
                  <p class="text-xs text-gray-500 mt-1">Aktu√°ln√≠: ${s.coffeePrice} Kƒç</p>
                </div>
                <button id="savePrice" class="w-full bg-amber-600 text-white py-3 rounded-xl font-semibold hover:bg-amber-700">Ulo≈æit</button>
              </div>
              
              <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-lg font-bold mb-4">Vytvo≈ôit u≈æivatele</h2>
                <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-3 mb-4 text-sm">
                  <p class="font-bold text-yellow-800 mb-1">‚ö†Ô∏è Postup:</p>
                  <ol class="text-yellow-700 list-decimal ml-4 space-y-1">
                    <li>Vypl≈à √∫daje n√≠≈æe</li>
                    <li>Vytvo≈ô u≈æivatele v Firebase Console</li>
                    <li>Zkop√≠ruj UID z Firebase</li>
                    <li>Klikni "Vytvo≈ôit" a vlo≈æ UID</li>
                  </ol>
                </div>
                <div class="mb-3">
                  <label class="block text-sm font-semibold mb-2">Jm√©no</label>
                  <input type="text" id="newUserName" value="${s.newUserName}" placeholder="Jan Nov√°k" 
                    class="w-full px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500">
                </div>
                <div class="mb-3">
                  <label class="block text-sm font-semibold mb-2">Email</label>
                  <input type="email" id="newUserEmail" value="${s.newUserEmail}" placeholder="jan@coffee.app" 
                    class="w-full px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500">
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-semibold mb-2">Heslo</label>
                  <input type="text" id="newUserPassword" value="${s.newUserPassword}" placeholder="Siln√© heslo" 
                    class="w-full px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500">
                </div>
                <button id="createUser" class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700">‚ûï Vytvo≈ôit</button>
              </div>

              <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                  <h2 class="text-lg font-bold">U≈æivatel√©</h2>
                  <button id="refresh" class="text-sm text-blue-600 hover:text-blue-700 font-semibold">Obnovit</button>
                </div>
                ${s.allUsers.length > 0 ? `<div class="space-y-2">${s.allUsers.map(u => `
                  <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                      <p class="font-semibold">${u.name}</p>
                      <p class="text-xs text-gray-500">${u.email}</p>
                      <p class="text-sm text-gray-600">Mƒõs√≠c: ${u.monthlyTotal} k√°v</p>
                    </div>
                    <div class="text-right">
                      <p class="font-bold text-amber-600">${u.monthlyTotal * s.coffeePrice} Kƒç</p>
                      <p class="text-xs text-gray-500">Celkem: ${u.allTimeCount}</p>
                    </div>
                  </div>
                `).join('')}</div>` : '<p class="text-gray-500 text-center py-4">≈Ω√°dn√≠ u≈æivatel√©</p>'}
              </div>
            </div>
          </div>
        `;
      }

      attachListeners() {
        const s = this.state;
        
        if (s.view === 'login') {
          const emailInput = document.getElementById('loginEmail');
          const passInput = document.getElementById('loginPassword');
          const loginBtn = document.getElementById('loginBtn');

          emailInput?.addEventListener('input', e => s.loginEmail = e.target.value);
          passInput?.addEventListener('input', e => s.loginPassword = e.target.value);
          passInput?.addEventListener('keypress', e => {
            if (e.key === 'Enter') this.userLogin();
          });
          loginBtn?.addEventListener('click', () => this.userLogin());
        }

        if (s.view === 'main') {
          document.getElementById('logoutBtn')?.addEventListener('click', () => {
            if (confirm('Odhl√°sit?')) this.logout();
          });
          document.getElementById('allLog')?.addEventListener('click', () => { s.view = 'alltimelog'; this.render(); });
          document.getElementById('monthLog')?.addEventListener('click', () => { s.view = 'monthlylog'; this.render(); });
          document.getElementById('add1')?.addEventListener('click', () => this.addCoffee(1));
          document.getElementById('add2')?.addEventListener('click', () => this.addCoffee(2));
          document.getElementById('addCustom')?.addEventListener('click', () => {
            const val = parseInt(document.getElementById('custom').value);
            if (val > 0) this.addCoffee(val);
          });
          document.getElementById('payBtn')?.addEventListener('click', () => this.confirmPayment());
          document.getElementById('adminBtn')?.addEventListener('click', () => { s.view = 'admin'; this.render(); });
        }

        if (s.view === 'alltimelog') {
          document.getElementById('back')?.addEventListener('click', () => { s.view = 'main'; this.render(); });
          
          document.querySelectorAll('[data-toggle-year]').forEach(btn => {
            btn.addEventListener('click', () => this.toggleYear(btn.dataset.toggleYear));
          });
          
          document.querySelectorAll('[data-toggle-month]').forEach(btn => {
            btn.addEventListener('click', () => this.toggleMonth(btn.dataset.toggleMonth));
          });
          
          document.querySelectorAll('[data-toggle-week]').forEach(btn => {
            btn.addEventListener('click', () => this.toggleWeek(btn.dataset.toggleWeek));
          });
        }

        if (s.view === 'monthlylog') {
          document.getElementById('back')?.addEventListener('click', () => { s.view = 'main'; this.render(); });
        }

        if (s.view === 'admin') {
          document.getElementById('back')?.addEventListener('click', () => { s.view = 'main'; this.render(); });
          document.getElementById('newName')?.addEventListener('input', e => s.newCoffeeName = e.target.value);
          document.getElementById('newPrice')?.addEventListener('input', e => s.newPrice = e.target.value);
          document.getElementById('savePrice')?.addEventListener('click', () => this.updatePrice());
          document.getElementById('newUserName')?.addEventListener('input', e => s.newUserName = e.target.value);
          document.getElementById('newUserEmail')?.addEventListener('input', e => s.newUserEmail = e.target.value);
          document.getElementById('newUserPassword')?.addEventListener('input', e => s.newUserPassword = e.target.value);
          document.getElementById('createUser')?.addEventListener('click', () => this.createUser());
          document.getElementById('refresh')?.addEventListener('click', () => this.loadUsers().then(() => this.render()));
        }
      }
    }

    const coffeeApp = new CoffeeApp();
    coffeeApp.init();
  </script>
</body>
</html>
