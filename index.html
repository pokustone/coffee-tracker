<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence kávy</title>
    <meta name="description" content="Aplikace pro evidenci spotřebované kávy">
    <meta name="theme-color" content="#21808D">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkV2aWRlbmNlIGvDoXZ5IiwKICAic2hvcnRfbmFtZSI6ICJLw6F2YSIsCiAgInN0YXJ0X3VybCI6ICIvIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjRkNGQ0Y5IiwKICAidGhlbWVfY29sb3IiOiAiIzIxODA4RCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmclMjB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnJTIwd2lkdGg9JzE5MiclMjBoZWlnaHQ9JzE5MiclM0UlM0NyZWN0JTIwd2lkdGg9JzE5MiclMjBoZWlnaHQ9JzE5MiclMjBmaWxsPSclMjMyMTgwOEQnLyUzRSUzQ3RleHQlMjB4PSc1MCUyNSclMjB5PSc1MCUyNSclMjBmb250LXNpemU9JzEwMCclMjBkb21pbmFudC1iYXNlbGluZT0nbWlkZGxlJyUyMHRleHQtYW5jaG9yPSdtaWRkbGUnJTIwZmlsbD0nJTIzRkZGJyUzRSVFMiU5OCU5NSUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyUyMHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyclMjB3aWR0aD0nNTEyJyUyMGhlaWdodD0nNTEyJyUzRSUzQ3JlY3QlMjB3aWR0aD0nNTEyJyUyMGhlaWdodD0nNTEyJyUyMGZpbGw9JyUyMzIxODA4RCcvJTNFJTNDdGV4dCUyMHg9JzUwJTI1JyUyMHk9JzUwJTI1JyUyMGZvbnQtc2l6ZT0nMzAwJyUyMGRvbWluYW50LWJhc2VsaW5lPSdtaWRkbGUnJTIwdGV4dC1hbmNob3I9J21pZGRsZSclMjBmaWxsPSclMjNGRkYnJTNFJUUyJTk4JTk1JTNDL3RleHQlM0UlM0Mvc3ZnJTNFIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Crect width='180' height='180' fill='%2321808D'/%3E%3Ctext x='50%25' y='50%25' font-size='90' dominant-baseline='middle' text-anchor='middle' fill='%23FFF'%3E☕%3C/text%3E%3C/svg%3E">
    <style>
        :root {
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-gray-400-rgb: 119, 124, 124;
            --color-teal-300-rgb: 50, 184, 198;

            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            
            --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;
            --radius-base: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: rgba(167, 169, 169, 0.7);
                --color-primary: var(--color-teal-300);
                --color-primary-hover: rgba(50, 184, 198, 0.9);
                --color-primary-active: rgba(50, 184, 198, 0.8);
                --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
                --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
                --color-border: rgba(var(--color-gray-400-rgb), 0.3);
                --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
                --color-btn-primary-text: var(--color-slate-900);
            }
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-family: var(--font-family-base);
            -webkit-font-smoothing: antialiased;
        }

        body {
            background: var(--color-background);
            color: var(--color-text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: var(--space-20);
            flex: 1;
        }

        .header {
            text-align: center;
            margin-bottom: var(--space-32);
            padding-top: var(--space-20);
        }

        .header h1 {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: var(--space-8);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-12);
        }

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            margin-bottom: var(--space-20);
            box-shadow: var(--shadow-sm);
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-16);
            margin-bottom: var(--space-24);
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-8);
        }

        .stat-value {
            font-size: 36px;
            font-weight: 600;
            color: var(--color-primary);
        }

        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-16);
            margin-bottom: var(--space-24);
        }

        .btn {
            padding: var(--space-20);
            border: none;
            border-radius: var(--radius-base);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-8);
        }

        .btn-primary {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-primary:active {
            background: var(--color-primary-active);
            transform: scale(0.98);
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: var(--color-secondary-hover);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .payment-section {
            border-top: 1px solid var(--color-border);
            padding-top: var(--space-24);
            margin-top: var(--space-24);
        }

        .payment-info {
            background: var(--color-secondary);
            padding: var(--space-16);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
        }

        .payment-info p {
            margin-bottom: var(--space-8);
            font-size: 14px;
        }

        .payment-info strong {
            color: var(--color-primary);
            font-size: 18px;
        }

        .bank-account {
            font-family: monospace;
            background: var(--color-surface);
            padding: var(--space-8);
            border-radius: var(--radius-base);
            margin-top: var(--space-8);
            font-size: 16px;
        }

        .status-message {
            padding: var(--space-12);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
            font-size: 14px;
            text-align: center;
        }

        .status-success {
            background: rgba(var(--color-teal-500-rgb), 0.15);
            color: var(--color-primary);
            border: 1px solid rgba(var(--color-teal-500-rgb), 0.25);
        }

        .status-error {
            background: rgba(220, 38, 38, 0.15);
            color: #dc2626;
            border: 1px solid rgba(220, 38, 38, 0.25);
        }

        .loading {
            text-align: center;
            padding: var(--space-32);
            color: var(--color-text-secondary);
        }

        .spinner {
            border: 3px solid var(--color-secondary);
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--space-16);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            padding: var(--space-20);
            color: var(--color-text-secondary);
            font-size: 12px;
        }

        .setup-screen {
            text-align: center;
        }

        .setup-screen h2 {
            margin-bottom: var(--space-16);
            font-size: 24px;
        }

        .setup-screen p {
            color: var(--color-text-secondary);
            margin-bottom: var(--space-24);
            line-height: 1.6;
        }

        .setup-screen .btn {
            max-width: 300px;
            margin: 0 auto;
        }

        @media (max-width: 480px) {
            .container {
                padding: var(--space-16);
            }
            
            .stat-value {
                font-size: 28px;
            }

            .buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span>☕</span> Evidence kávy</h1>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Načítání...</p>
        </div>

        <div id="setupScreen" class="card setup-screen" style="display: none;">
            <h2>Konfigurace aplikace</h2>
            <p>Pro použití této aplikace je potřeba nastavit Google Sheets API.</p>
            <p><strong>Instrukce:</strong></p>
            <ol style="text-align: left; max-width: 400px; margin: var(--space-24) auto; line-height: 1.8;">
                <li>Vytvoř Google Sheet s listy "Coffee_Log" a "Settings"</li>
                <li>V "Settings" přidej řádky: price_per_coffee, bank_account</li>
                <li>Zapni Google Sheets API v Google Cloud Console</li>
                <li>Vygeneruj API klíč a vlož ho do kódu (řádek s CONFIG)</li>
                <li>Nastav správné SHEET_ID v kódu</li>
            </ol>
            <button class="btn btn-secondary" onclick="location.reload()">
                Obnovit aplikaci
            </button>
        </div>

        <div id="mainApp" style="display: none;">
            <div id="statusMessage"></div>

            <div class="card">
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-label">Káv tento měsíc</div>
                        <div class="stat-value" id="coffeeCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">K úhradě</div>
                        <div class="stat-value" id="totalPrice">0 Kč</div>
                    </div>
                </div>

                <div class="buttons">
                    <button class="btn btn-primary" onclick="addCoffee(1)" id="btn1">
                        <span>☕</span> +1 káva
                    </button>
                    <button class="btn btn-primary" onclick="addCoffee(2)" id="btn2">
                        <span>☕☕</span> +2 kávy
                    </button>
                </div>

                <div id="paymentSection" class="payment-section" style="display: none;">
                    <div class="payment-info">
                        <p>Celkem k úhradě za tento měsíc:</p>
                        <p><strong id="paymentAmount">0 Kč</strong></p>
                        <p style="margin-top: var(--space-16);">Číslo účtu:</p>
                        <div class="bank-account" id="bankAccount">-</div>
                    </div>
                    <button class="btn btn-secondary" onclick="confirmPayment()" id="btnPaid">
                        ✓ Zaplaceno
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        Evidence kávy v1.0
    </div>

    <script>
        // ===== KONFIGURACE =====
        const CONFIG = {
            SHEET_ID: 'VÁŠ_GOOGLE_SHEET_ID_ZDE',
            API_KEY: 'VÁŠ_API_KEY_ZDE',
            SHEET_NAME_LOG: 'Coffee_Log',
            SHEET_NAME_SETTINGS: 'Settings'
        };

        // ===== SPRÁVA UŽIVATELSKÉHO ID =====
        function getUserId() {
            let userId = localStorage.getItem('coffee_user_id');
            if (!userId) {
                userId = generateUUID();
                localStorage.setItem('coffee_user_id', userId);
            }
            return userId;
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // ===== GLOBÁLNÍ STAV =====
        let currentMonth = '';
        let coffeeCount = 0;
        let pricePerCoffee = 20;
        let bankAccount = '';
        let isPaid = false;
        const userId = getUserId();

        // ===== API FUNKCE =====
        async function fetchSheetData(range) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${range}?key=${CONFIG.API_KEY}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Chyba při načítání dat');
            return await response.json();
        }

        async function appendSheetData(range, values) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${range}:append?valueInputOption=USER_ENTERED&key=${CONFIG.API_KEY}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ values: [values] })
            });
            if (!response.ok) throw new Error('Chyba při ukládání dat');
            return await response.json();
        }

        async function updateSheetData(range, values) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.SHEET_ID}/values/${range}?valueInputOption=USER_ENTERED&key=${CONFIG.API_KEY}`;
            const response = await fetch(url, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ values: [values] })
            });
            if (!response.ok) throw new Error('Chyba při aktualizaci dat');
            return await response.json();
        }

        // ===== NAČTENÍ NASTAVENÍ =====
        async function loadSettings() {
            try {
                const data = await fetchSheetData(CONFIG.SHEET_NAME_SETTINGS);
                if (data.values) {
                    data.values.forEach(row => {
                        if (row[0] === 'price_per_coffee') pricePerCoffee = parseFloat(row[1]) || 20;
                        if (row[0] === 'bank_account') bankAccount = row[1] || '';
                    });
                }
            } catch (error) {
                console.error('Chyba načítání nastavení:', error);
            }
        }

        // ===== NAČTENÍ DAT UŽIVATELE =====
        async function loadUserData() {
            currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            
            try {
                const data = await fetchSheetData(CONFIG.SHEET_NAME_LOG);
                let userRow = null;
                let rowIndex = -1;

                if (data.values) {
                    data.values.forEach((row, index) => {
                        if (row[0] === userId && row[1] === currentMonth) {
                            userRow = row;
                            rowIndex = index + 1;
                        }
                    });
                }

                if (userRow) {
                    coffeeCount = parseInt(userRow[2]) || 0;
                    isPaid = userRow[3] === 'TRUE';
                } else {
                    coffeeCount = 0;
                    isPaid = false;
                    await appendSheetData(CONFIG.SHEET_NAME_LOG, [userId, currentMonth, 0, 'FALSE']);
                }

                updateUI();
            } catch (error) {
                console.error('Chyba načítání dat:', error);
                showStatus('Chyba při načítání dat. Zkontroluj konfiguraci.', 'error');
                document.getElementById('setupScreen').style.display = 'block';
            }
        }

        // ===== AKTUALIZACE UI =====
        function updateUI() {
            document.getElementById('coffeeCount').textContent = coffeeCount;
            const total = coffeeCount * pricePerCoffee;
            document.getElementById('totalPrice').textContent = `${total} Kč`;
            document.getElementById('paymentAmount').textContent = `${total} Kč`;
            document.getElementById('bankAccount').textContent = bankAccount;

            const btn1 = document.getElementById('btn1');
            const btn2 = document.getElementById('btn2');
            const btnPaid = document.getElementById('btnPaid');
            const paymentSection = document.getElementById('paymentSection');

            btn1.disabled = false;
            btn2.disabled = false;
            btnPaid.disabled = isPaid;
            paymentSection.style.display = coffeeCount > 0 ? 'block' : 'none';

            if (isPaid) {
                showStatus('Platba byla potvrzena. Pokračuj v evidenci pro další měsíc.', 'success');
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }

        // ===== PŘIDÁNÍ KÁVY =====
        async function addCoffee(count) {
            const btn1 = document.getElementById('btn1');
            const btn2 = document.getElementById('btn2');
            btn1.disabled = true;
            btn2.disabled = true;

            try {
                const data = await fetchSheetData(CONFIG.SHEET_NAME_LOG);
                let rowIndex = -1;

                if (data.values) {
                    data.values.forEach((row, index) => {
                        if (row[0] === userId && row[1] === currentMonth) {
                            rowIndex = index + 1;
                        }
                    });
                }

                if (rowIndex > 0) {
                    coffeeCount += count;
                    await updateSheetData(
                        `${CONFIG.SHEET_NAME_LOG}!A${rowIndex}:D${rowIndex}`,
                        [userId, currentMonth, coffeeCount, 'FALSE']
                    );
                    showStatus(`Přidáno ${count} ${count === 1 ? 'káva' : 'kávy'}!`, 'success');
                    updateUI();
                }
            } catch (error) {
                console.error('Chyba při přidávání kávy:', error);
                showStatus('Chyba při ukládání. Zkus to znovu.', 'error');
            } finally {
                btn1.disabled = false;
                btn2.disabled = false;
            }
        }

        // ===== POTVRZENÍ PLATBY =====
        async function confirmPayment() {
            if (!confirm(`Potvrzuješ platbu ${coffeeCount * pricePerCoffee} Kč za tento měsíc?`)) {
                return;
            }

            document.getElementById('btnPaid').disabled = true;

            try {
                const data = await fetchSheetData(CONFIG.SHEET_NAME_LOG);
                let rowIndex = -1;

                if (data.values) {
                    data.values.forEach((row, index) => {
                        if (row[0] === userId && row[1] === currentMonth) {
                            rowIndex = index + 1;
                        }
                    });
                }

                if (rowIndex > 0) {
                    await updateSheetData(
                        `${CONFIG.SHEET_NAME_LOG}!A${rowIndex}:D${rowIndex}`,
                        [userId, currentMonth, coffeeCount, 'TRUE']
                    );
                    isPaid = true;
                    showStatus('Platba potvrzena! Nový měsíc začne automaticky.', 'success');
                    updateUI();
                }
            } catch (error) {
                console.error('Chyba při potvrzování platby:', error);
                showStatus('Chyba při ukládání. Zkus to znovu.', 'error');
                document.getElementById('btnPaid').disabled = false;
            }
        }

        // ===== ZOBRAZENÍ ZPRÁVY =====
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        // ===== INICIALIZACE =====
        async function init() {
            if (CONFIG.SHEET_ID === 'VÁŠ_GOOGLE_SHEET_ID_ZDE' || CONFIG.API_KEY === 'VÁŠ_API_KEY_ZDE') {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('setupScreen').style.display = 'block';
                return;
            }

            await loadSettings();
            await loadUserData();
        }

        // ===== SERVICE WORKER PRO PWA =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    self.addEventListener('install', (e) => {
                        self.skipWaiting();
                    });
                    self.addEventListener('activate', (e) => {
                        self.clients.claim();
                    });
                    self.addEventListener('fetch', (e) => {
                        e.respondWith(
                            fetch(e.request).catch(() => {
                                return new Response('Offline - připoj se k internetu', {
                                    headers: { 'Content-Type': 'text/plain' }
                                });
                            })
                        );
                    });
                `;
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl);
            });
        }

        // Spuštění aplikace
        init();
    </script>
</body>
</html>
