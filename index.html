<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#d97706">
  <title>Coffee Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, doc, getDoc, setDoc, getDocs, query } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyA0jwdsajnjCHkTh0thPMgsJXyP3XE61CI",
      authDomain: "my-coffee-tracker-7704e.firebaseapp.com",
      projectId: "my-coffee-tracker-7704e",
      storageBucket: "my-coffee-tracker-7704e.firebasestorage.app",
      messagingSenderId: "217300709501",
      appId: "1:217300709501:web:3ccc93a3ae8837713e8114",
      measurementId: "G-F1M0FQ951H"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const BANK_ACCOUNT = "340840719/0300";
    const ADMIN_EMAIL = "nemec.jakub@gmail.com";

    window.storage = {
      async get(key) {
        const docRef = doc(db, 'storage', key);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) return { key, value: docSnap.data().value };
        throw new Error('Not found');
      },
      async set(key, value) {
        await setDoc(doc(db, 'storage', key), { value, updated: new Date().toISOString() });
        return { key, value };
      },
      async list(prefix) {
        const q = query(collection(db, 'storage'));
        const snap = await getDocs(q);
        const keys = [];
        snap.forEach(d => { if (d.id.startsWith(prefix || '')) keys.push(d.id); });
        return { keys };
      }
    };

    class CoffeeApp {
      constructor() {
        this.state = {
          view: 'login',
          userId: null,
          userName: '',
          coffeeCount: 0,
          monthlyTotal: 0,
          coffeePrice: 15,
          coffeeName: '',
          isAdmin: false,
          allUsers: [],
          allTimeLogs: [],
          monthlyLogs: [],
          loginCode: '',
          newUserName: '',
          newPrice: '15',
          newCoffeeName: '',
          customCount: '',
          adminEmail: '',
          adminPassword: '',
          showAdminLogin: false
        };

        onAuthStateChanged(auth, (user) => {
          if (user && user.email === ADMIN_EMAIL) {
            this.state.isAdmin = true;
            localStorage.setItem('coffeeAdmin', 'true');
          }
        });
      }

      getCurrentMonth() {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
      }

	isFirstDay() {
  	// Testovac√≠ re≈æim p≈ôes URL parametr
  	const urlParams = new URLSearchParams(window.location.search);
 	 if (urlParams.get('testFirstDay') === 'true') {
   	 return true;
 	 }
 	 return new Date().getDate() === 1;
	}

      generateCode() {
        return Math.floor(100000 + Math.random() * 900000).toString();
      }

      formatDate(ts) {
        return new Date(ts).toLocaleString('cs-CZ', {
          day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
        });
      }

      async init() {
        try {
          const pr = await storage.get('coffee:global:price');
          const data = JSON.parse(pr.value);
          this.state.coffeePrice = data.price;
          this.state.coffeeName = data.name || '';
          this.state.newPrice = data.price.toString();
          this.state.newCoffeeName = data.name || '';
        } catch (e) {
          await storage.set('coffee:global:price', JSON.stringify({ price: 15, name: '' }));
        }

        const code = localStorage.getItem('coffeeUserCode');
        if (code) {
          await this.login(code);
        } else {
          this.render();
        }

        this.state.isAdmin = localStorage.getItem('coffeeAdmin') === 'true';
      }

      async login(code) {
        try {
          const u = await storage.get(`user:${code}`);
          const userData = JSON.parse(u.value);
          this.state.userId = code;
          this.state.userName = userData.name;
          localStorage.setItem('coffeeUserCode', code);
          await this.loadUserData(code);
          this.state.view = 'main';
          this.render();
        } catch (e) {
          alert('Neplatn√Ω k√≥d!');
        }
      }

      async adminLogin() {
        try {
          const userCredential = await signInWithEmailAndPassword(auth, this.state.adminEmail, this.state.adminPassword);
          if (userCredential.user.email === ADMIN_EMAIL) {
            this.state.isAdmin = true;
            localStorage.setItem('coffeeAdmin', 'true');
            this.state.view = 'admin';
            await this.loadUsers();
            this.render();
          } else {
            await signOut(auth);
            alert('Pouze admin m√° p≈ô√≠stup!');
          }
        } catch (error) {
          console.error('Admin login error:', error);
          if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
            alert('≈†patn√Ω email nebo heslo!');
          } else if (error.code === 'auth/invalid-email') {
            alert('Neplatn√Ω email!');
          } else if (error.code === 'auth/too-many-requests') {
            alert('P≈ô√≠li≈° mnoho pokus≈Ø. Zkuste to pozdƒõji.');
          } else {
            alert('Chyba p≈ôihl√°≈°en√≠: ' + error.message);
          }
        }
      }

      async adminLogout() {
        try {
          await signOut(auth);
          this.state.isAdmin = false;
          localStorage.removeItem('coffeeAdmin');
          this.state.view = 'login';
          this.render();
        } catch (error) {
          console.error('Logout error:', error);
        }
      }

      async loadUserData(code) {
        const month = this.getCurrentMonth();
        try {
          const m = await storage.get(`coffee:${code}:${month}`);
          this.state.monthlyTotal = JSON.parse(m.value).total || 0;
        } catch (e) { this.state.monthlyTotal = 0; }

        try {
          const t = await storage.get(`coffee:${code}:total`);
          this.state.coffeeCount = JSON.parse(t.value).count || 0;
        } catch (e) { this.state.coffeeCount = 0; }

        try {
          const l = await storage.get(`coffee:${code}:logs`);
          const logs = JSON.parse(l.value);
          this.state.allTimeLogs = logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          this.state.monthlyLogs = logs.filter(log => log.month === month).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        } catch (e) {
          this.state.allTimeLogs = [];
          this.state.monthlyLogs = [];
        }

        if (this.state.isAdmin) await this.loadUsers();
      }

      async loadUsers() {
        const keys = await storage.list('user:');
        const users = [];
        const month = this.getCurrentMonth();
        for (const k of keys.keys) {
          try {
            const code = k.replace('user:', '');
            const u = await storage.get(k);
            const m = await storage.get(`coffee:${code}:${month}`).catch(() => ({ value: '{"total":0}' }));
            const t = await storage.get(`coffee:${code}:total`).catch(() => ({ value: '{"count":0}' }));
            users.push({
              code,
              name: JSON.parse(u.value).name,
              monthlyTotal: JSON.parse(m.value).total || 0,
              allTimeCount: JSON.parse(t.value).count || 0
            });
          } catch (e) { }
        }
        this.state.allUsers = users.sort((a, b) => b.monthlyTotal - a.monthlyTotal);
      }

      async addCoffee(count) {
        if (this.isFirstDay() && this.state.monthlyTotal > 0) {
          alert('Nejprve potvrƒè platbu!');
          return;
        }

        const month = this.getCurrentMonth();
        const logs = this.state.allTimeLogs;
        logs.push({
          count, price: this.state.coffeePrice, coffeeName: this.state.coffeeName,
          timestamp: new Date().toISOString(), month
        });

        await storage.set(`coffee:${this.state.userId}:logs`, JSON.stringify(logs));
        await storage.set(`coffee:${this.state.userId}:${month}`, JSON.stringify({
          total: this.state.monthlyTotal + count, userName: this.state.userName
        }));
        await storage.set(`coffee:${this.state.userId}:total`, JSON.stringify({
          count: this.state.coffeeCount + count
        }));

        this.state.monthlyTotal += count;
        this.state.coffeeCount += count;
        await this.loadUserData(this.state.userId);
        this.render();
      }

      async confirmPayment() {
        if (!confirm(`Potvrdit ${this.state.monthlyTotal * this.state.coffeePrice} Kƒç?`)) return;
        const month = this.getCurrentMonth();
        await storage.set(`coffee:${this.state.userId}:payment:${month}`, JSON.stringify({
          month, coffees: this.state.monthlyTotal, amount: this.state.monthlyTotal * this.state.coffeePrice,
          paidDate: new Date().toISOString()
        }));
        await storage.set(`coffee:${this.state.userId}:${month}`, JSON.stringify({
          total: 0, userName: this.state.userName
        }));
        this.state.monthlyTotal = 0;
        await this.loadUserData(this.state.userId);
        alert('Platba potvrzena!');
        this.render();
      }

      async createUser() {
        if (!this.state.newUserName.trim()) return alert('Zadej jm√©no!');
        const code = this.generateCode();
        const month = this.getCurrentMonth();
        
        await storage.set(`user:${code}`, JSON.stringify({
          code, name: this.state.newUserName.trim(), createdAt: new Date().toISOString()
        }));
        await storage.set(`coffee:${code}:${month}`, JSON.stringify({ total: 0, userName: this.state.newUserName.trim() }));
        await storage.set(`coffee:${code}:total`, JSON.stringify({ count: 0 }));
        await storage.set(`coffee:${code}:logs`, JSON.stringify([]));

        this.state.newUserName = '';
        await this.loadUsers();
        alert(`K√≥d: ${code}`);
        try { await navigator.clipboard.writeText(code); alert('Zkop√≠rov√°no!'); } catch (e) { }
        this.render();
      }

      async updatePrice() {
        const price = parseInt(this.state.newPrice);
        if (price > 0) {
          await storage.set('coffee:global:price', JSON.stringify({
            price, name: this.state.newCoffeeName.trim()
          }));
          this.state.coffeePrice = price;
          this.state.coffeeName = this.state.newCoffeeName.trim();
          alert('Ulo≈æeno!');
          this.state.view = 'main';
          this.render();
        }
      }

      render() {
        const el = document.getElementById('app');
        el.innerHTML = this[`render${this.state.view.charAt(0).toUpperCase() + this.state.view.slice(1)}`]();
        this.attachListeners();
      }

      renderLogin() {
        if (this.state.showAdminLogin) {
          return `
            <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 flex items-center justify-center p-4">
              <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
                <div class="text-6xl text-center mb-6">‚òï</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">Admin P≈ôihl√°≈°en√≠</h2>
                <p class="text-gray-600 mb-6 text-center">Zabezpeƒçen√© p≈ôihl√°≈°en√≠ p≈ôes Firebase</p>
                
                <div class="mb-4">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                  <input type="email" id="adminEmail" placeholder="admin@email.cz" 
                    class="w-full px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500">
                </div>
                
                <div class="mb-6">
                  <label class="block text-sm font-semibold text-gray-700 mb-2">Heslo</label>
                  <input type="password" id="adminPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                    class="w-full px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500">
                </div>
                
                <button id="adminLoginBtn" class="w-full bg-gray-800 text-white py-3 rounded-xl font-semibold hover:bg-gray-900 mb-3">
                  üîê P≈ôihl√°sit jako Admin
                </button>
                
                <button id="backToUser" class="w-full text-gray-600 py-2 rounded-xl hover:bg-gray-100">
                  ‚Üê Zpƒõt na u≈æivatelsk√© p≈ôihl√°≈°en√≠
                </button>
              </div>
            </div>
          `;
        }

        return `
          <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
              <div class="text-6xl text-center mb-6">‚òï</div>
              <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">Coffee Tracker</h2>
              <p class="text-gray-600 mb-6 text-center">P≈ôihla≈° se sv√Ωm k√≥dem</p>
              <input type="text" id="code" maxlength="6" placeholder="6m√≠stn√Ω k√≥d" 
                class="w-full px-4 py-3 border-2 rounded-xl mb-4 text-lg text-center font-mono tracking-widest focus:border-amber-500 outline-none">
              <button id="loginBtn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 mb-3">
                P≈ôihl√°sit se
              </button>
              <div class="relative my-6"><div class="absolute inset-0 flex items-center"><div class="w-full border-t"></div></div>
              <div class="relative flex justify-center text-sm"><span class="px-4 bg-white text-gray-500">nebo</span></div></div>
              <button id="showAdminBtn" class="w-full bg-gray-800 text-white py-3 rounded-xl font-semibold hover:bg-gray-900">
                ‚öôÔ∏è Admin p≈ô√≠stup
              </button>
              <p class="text-xs text-gray-500 text-center mt-4">
                Nem√°≈° p≈ôihla≈°ovac√≠ k√≥d? Po≈æ√°dej admina o vytvo≈ôen√≠ √∫ƒçtu.
              </p>
            </div>
          </div>
        `;
      }

      renderMain() {
        const s = this.state;
        const firstDay = this.isFirstDay();
        return `
          <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100">
            <div class="bg-white shadow-md">
              <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                  <div class="text-3xl">‚òï</div>
                  <div><h1 class="text-xl font-bold">Coffee Tracker</h1><p class="text-sm text-gray-600">${s.userName}</p></div>
                </div>
                <div class="flex gap-2">
                  ${s.isAdmin ? '<button id="adminBtn" class="text-gray-400 hover:text-gray-600 p-2">‚öôÔ∏è</button>' : ''}
                  <button id="logoutBtn" class="text-gray-400 hover:text-red-600 p-2">üö™</button>
                </div>
              </div>
            </div>
            <div class="max-w-4xl mx-auto p-4 space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <button id="allLog" class="bg-white rounded-2xl shadow-lg p-6 text-left hover:shadow-xl">
                  <div class="flex items-center gap-2 mb-2"><span>üìà</span><span class="text-sm text-gray-600">Celkem k√°v</span></div>
                  <p class="text-4xl font-bold">${s.coffeeCount}</p>
                </button>
                <button id="monthLog" class="bg-white rounded-2xl shadow-lg p-6 text-left hover:shadow-xl">
                  <div class="flex items-center gap-2 mb-2"><span>‚òï</span><span class="text-sm text-gray-600">Tento mƒõs√≠c</span></div>
                  <p class="text-4xl font-bold text-amber-600">${s.monthlyTotal}</p>
                </button>
              </div>
              ${!firstDay || s.monthlyTotal === 0 ? `
                <div class="bg-white rounded-2xl shadow-lg p-6">
                  <h2 class="text-lg font-bold mb-4">P≈ôidat k√°vu</h2>
                  ${s.coffeeName ? `<p class="text-sm text-amber-600 mb-3">‚òï ${s.coffeeName}</p>` : ''}
                  <div class="flex gap-3 mb-4">
                    <button id="add1" class="flex-1 bg-amber-500 text-white py-4 rounded-xl font-bold text-xl hover:bg-amber-600">‚ûï Single</button>
                    <button id="add2" class="flex-1 bg-amber-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-amber-700">‚ûï Double</button>
                  </div>
                  <div class="flex gap-3">
                    <input type="number" id="custom" min="1" placeholder="Vlastn√≠ poƒçet" class="flex-1 px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500">
                    <button id="addCustom" class="bg-gray-800 text-white px-6 py-3 rounded-xl font-semibold hover:bg-gray-900">P≈ôidat</button>
                  </div>
                </div>
              ` : ''}
              ${firstDay && s.monthlyTotal > 0 ? `
                <div class="bg-gradient-to-br from-green-50 to-emerald-100 rounded-2xl shadow-lg p-6 border-2 border-green-200">
                  <h2 class="text-lg font-bold mb-4">Mƒõs√≠ƒçn√≠ √∫ƒçet</h2>
                  <div class="space-y-3 mb-4">
                    <div class="flex justify-between text-gray-700"><span>Poƒçet k√°v:</span><span class="font-bold">${s.monthlyTotal}</span></div>
                    <div class="flex justify-between text-gray-700"><span>Cena:</span><span class="font-bold">${s.coffeePrice} Kƒç</span></div>
                    <div class="h-px bg-gray-300"></div>
                    <div class="flex justify-between text-xl font-bold"><span>Celkem:</span><span class="text-green-600">${s.monthlyTotal * s.coffeePrice} Kƒç</span></div>
                  </div>
                  <div class="bg-white rounded-xl p-4 mb-4">
                    <p class="text-sm text-gray-600 mb-1">ƒå√≠slo √∫ƒçtu:</p>
                    <p class="text-lg font-mono font-bold">${BANK_ACCOUNT}</p>
                  </div>
                  <button id="payBtn" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700">‚úÖ Zaplaceno</button>
                </div>
                <div class="bg-red-50 rounded-xl p-4 text-sm text-red-700 border-2 border-red-200">
                  <p class="font-bold mb-1">‚ö†Ô∏è Nov√Ω mƒõs√≠c - Platba nutn√°</p>
                  <p>Potvrƒè platbu za minul√Ω mƒõs√≠c.</p>
                </div>
              ` : ''}
              <div class="bg-blue-50 rounded-xl p-4 text-sm">
                <div class="flex justify-between items-start mb-2">
                  <div><p class="mb-1">üîë <strong>K√≥d:</strong></p><p class="text-2xl font-mono font-bold text-blue-600">${s.userId}</p></div>
                  <button id="copyBtn" class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700">üìã</button>
                </div>
                <p class="text-xs text-gray-600">Ulo≈æ si ho pro p≈ôihl√°≈°en√≠ z jin√©ho za≈ô√≠zen√≠.</p>
              </div>
            </div>
          </div>
        `;
      }

      renderAlltimelog() {
        return this.renderLog('Historie - Celkem', this.state.allTimeLogs, this.state.coffeeCount);
      }

      renderMonthlylog() {
        return this.renderLog('Historie - Mƒõs√≠c', this.state.monthlyLogs, this.state.monthlyTotal);
      }

      renderLog(title, logs, count) {
        return `
          <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100">
            <div class="bg-white shadow-md">
              <div class="max-w-4xl mx-auto px-4 py-4 flex items-center gap-3">
                <button id="back" class="text-gray-600 hover:text-gray-800">‚óÄÔ∏è</button>
                <div><h1 class="text-xl font-bold">${title}</h1><p class="text-sm text-gray-600">${count} k√°v</p></div>
              </div>
            </div>
            <div class="max-w-4xl mx-auto p-4">
              <div class="bg-white rounded-2xl shadow-lg p-6">
                ${logs.length > 0 ? `<div class="space-y-2">${logs.map(l => `
                  <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                      <p class="font-semibold">${l.count}x k√°va</p>
                      ${l.coffeeName ? `<p class="text-sm text-amber-600">‚òï ${l.coffeeName}</p>` : ''}
                      <p class="text-sm text-gray-600">${this.formatDate(l.timestamp)}</p>
                    </div>
                    <div class="text-right">
                      <p class="font-bold text-amber-600">${l.count * l.price} Kƒç</p>
                      <p class="text-xs text-gray-500">${l.price} Kƒç/ks</p>
                    </div>
                  </div>
                `).join('')}</div>` : '<p class="text-gray-500 text-center py-8">≈Ω√°dn√© z√°znamy</p>'}
              </div>
            </div>
          </div>
        `;
      }

      renderAdmin() {
        const s = this.state;
        return `
          <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100">
            <div class="bg-white shadow-md">
              <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                  <button id="back" class="text-gray-600 hover:text-gray-800">‚óÄÔ∏è</button>
                  <h1 class="text-xl font-bold">Admin</h1>
                </div>
                <button id="adminLogoutBtn" class="text-red-600 hover:text-red-700 font-semibold text-sm">
                  Odhl√°sit Admin
                </button>
              </div>
            </div>
            <div class="max-w-4xl mx-auto p-4 space-y-4">
              <div class="bg-green-50 rounded-xl p-4 border-2 border-green-200">
                <p class="text-sm text-green-700">üîê <strong>Zabezpeƒçeno:</strong> P≈ôihl√°≈°en p≈ôes Firebase Authentication</p>
              </div>
              <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-lg font-bold mb-4">Nastaven√≠ k√°vy</h2>
                <div class="mb-4">
                  <label class="block text-sm font-semibold mb-2">N√°zev</label>
                  <input type="text" id="newName" value="${s.newCoffeeName}" placeholder="Ethiopia..." 
                    class="w-full px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500">
                  <p class="text-xs text-gray-500 mt-1">Aktu√°ln√≠: ${s.coffeeName || 'Bez n√°zvu'}</p>
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-semibold mb-2">Cena</label>
                  <div class="flex gap-3">
                    <input type="number" id="newPrice" value="${s.newPrice}" 
                      class="flex-1 px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500">
                    <div class="flex items-center px-4 font-semibold">Kƒç</div>
                  </div>
                  <p class="text-xs text-gray-500 mt-1">Aktu√°ln√≠: ${s.coffeePrice} Kƒç</p>
                </div>
                <button id="savePrice" class="w-full bg-amber-600 text-white py-3 rounded-xl font-semibold hover:bg-amber-700">Ulo≈æit</button>
              </div>
              <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-lg font-bold mb-4">Vytvo≈ôit u≈æivatele</h2>
                <input type="text" id="newUser" value="${s.newUserName}" placeholder="Jm√©no" 
                  class="w-full px-4 py-3 border-2 rounded-xl text-lg mb-4 outline-none focus:border-amber-500">
                <button id="createUser" class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700">‚ûï Vytvo≈ôit</button>
              </div>
              <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                  <h2 class="text-lg font-bold">U≈æivatel√©</h2>
                  <button id="refresh" class="text-sm text-blue-600 hover:text-blue-700 font-semibold">Obnovit</button>
                </div>
                ${s.allUsers.length > 0 ? `<div class="space-y-2">${s.allUsers.map(u => `
                  <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                      <p class="font-semibold">${u.name}</p>
                      <p class="text-xs text-gray-500">K√≥d: ${u.code}</p>
                      <p class="text-sm text-gray-600">Mƒõs√≠c: ${u.monthlyTotal} k√°v</p>
                    </div>
                    <div class="text-right">
                      <p class="font-bold text-amber-600">${u.monthlyTotal * s.coffeePrice} Kƒç</p>
                      <p class="text-xs text-gray-500">Celkem: ${u.allTimeCount}</p>
                    </div>
                  </div>
                `).join('')}</div>` : '<p class="text-gray-500 text-center py-4">≈Ω√°dn√≠ u≈æivatel√©</p>'}
              </div>
            </div>
          </div>
        `;
      }

      attachListeners() {
        const s = this.state;
        
        if (s.view === 'login') {
          if (s.showAdminLogin) {
            const emailInput = document.getElementById('adminEmail');
            const passInput = document.getElementById('adminPassword');
            const adminLoginBtn = document.getElementById('adminLoginBtn');
            const backToUser = document.getElementById('backToUser');

            emailInput?.addEventListener('input', e => s.adminEmail = e.target.value);
            passInput?.addEventListener('input', e => s.adminPassword = e.target.value);
            passInput?.addEventListener('keypress', e => {
              if (e.key === 'Enter') this.adminLogin();
            });
            adminLoginBtn?.addEventListener('click', () => this.adminLogin());
            backToUser?.addEventListener('click', () => {
              s.showAdminLogin = false;
              this.render();
            });
          } else {
            const code = document.getElementById('code');
            const loginBtn = document.getElementById('loginBtn');
            const showAdminBtn = document.getElementById('showAdminBtn');
            
            code?.addEventListener('input', e => {
              e.target.value = e.target.value.replace(/\D/g, '').substring(0, 6);
              s.loginCode = e.target.value;
            });
            code?.addEventListener('keypress', e => {
              if (e.key === 'Enter' && s.loginCode.length === 6) this.login(s.loginCode);
            });
            loginBtn?.addEventListener('click', () => s.loginCode.length === 6 && this.login(s.loginCode));
            showAdminBtn?.addEventListener('click', () => {
              s.showAdminLogin = true;
              this.render();
            });
          }
        }

        if (s.view === 'main') {
          document.getElementById('logoutBtn')?.addEventListener('click', () => {
            if (confirm('Odhl√°sit?')) {
              localStorage.removeItem('coffeeUserCode');
              s.userId = null;
              s.view = 'login';
              this.render();
            }
          });
          document.getElementById('allLog')?.addEventListener('click', () => { s.view = 'alltimelog'; this.render(); });
          document.getElementById('monthLog')?.addEventListener('click', () => { s.view = 'monthlylog'; this.render(); });
          document.getElementById('add1')?.addEventListener('click', () => this.addCoffee(1));
          document.getElementById('add2')?.addEventListener('click', () => this.addCoffee(2));
          document.getElementById('addCustom')?.addEventListener('click', () => {
            const val = parseInt(document.getElementById('custom').value);
            if (val > 0) this.addCoffee(val);
          });
          document.getElementById('payBtn')?.addEventListener('click', () => this.confirmPayment());
          document.getElementById('copyBtn')?.addEventListener('click', () => {
            navigator.clipboard.writeText(s.userId);
            alert('Zkop√≠rov√°no!');
          });
          document.getElementById('adminBtn')?.addEventListener('click', () => { s.view = 'admin'; this.render(); });
        }

        if (s.view === 'alltimelog' || s.view === 'monthlylog') {
          document.getElementById('back')?.addEventListener('click', () => { s.view = 'main'; this.render(); });
        }

        if (s.view === 'admin') {
          document.getElementById('back')?.addEventListener('click', () => { s.view = 'main'; this.render(); });
          document.getElementById('adminLogoutBtn')?.addEventListener('click', () => this.adminLogout());
          document.getElementById('newName')?.addEventListener('input', e => s.newCoffeeName = e.target.value);
          document.getElementById('newPrice')?.addEventListener('input', e => s.newPrice = e.target.value);
          document.getElementById('savePrice')?.addEventListener('click', () => this.updatePrice());
          document.getElementById('newUser')?.addEventListener('input', e => s.newUserName = e.target.value);
          document.getElementById('createUser')?.addEventListener('click', () => this.createUser());
          document.getElementById('refresh')?.addEventListener('click', () => this.loadUsers().then(() => this.render()));
        }
      }
    }

    const coffeeApp = new CoffeeApp();
    coffeeApp.init();
  </script>
</body>
</html>
