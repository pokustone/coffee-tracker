<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#d97706">
  <title>Coffee Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }
    .modal-content {
      background: white;
      border-radius: 1rem;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, doc, getDoc, setDoc, getDocs, query, deleteDoc, updateDoc, increment, arrayUnion, arrayRemove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyA0jwdsajnjCHkTh0thPMgsJXyP3XE61CI",
      authDomain: "my-coffee-tracker-7704e.firebaseapp.com",
      projectId: "my-coffee-tracker-7704e",
      storageBucket: "my-coffee-tracker-7704e.firebasestorage.app",
      messagingSenderId: "217300709501",
      appId: "1:217300709501:web:3ccc93a3ae8837713e8114",
      measurementId: "G-F1M0FQ951H"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const BANK_ACCOUNT = "340840719/0300";
    const ADMIN_EMAIL = "jnemec@csob.it";

    window.storage = {
      async get(key) {
        const docRef = doc(db, 'storage', key);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) return { key, value: docSnap.data().value };
        throw new Error('Not found');
      },
      async set(key, value) {
        await setDoc(doc(db, 'storage', key), { value, updated: new Date().toISOString() });
        return { key, value };
      },
      async list(prefix) {
        const q = query(collection(db, 'storage'));
        const snap = await getDocs(q);
        const keys = [];
        snap.forEach(d => { if (d.id.startsWith(prefix || '')) keys.push(d.id); });
        return { keys };
      }
    };

    class CoffeeApp {
      constructor() {
        this.state = {
          view: 'login',
          userId: null,
          userName: '',
          userEmail: '',
          coffeeCount: 0,
          monthlyTotal: 0,
          coffeePrice: 15,
          coffeeName: '',
          isAdmin: false,
          allUsers: [],
          allTimeLogs: [],
          monthlyLogs: [],
          loginEmail: '',
          loginPassword: '',
          newUserName: '',
          newUserEmail: '',
          newUserPassword: '',
          newPrice: '15',
          newCoffeeName: '',
          customCount: '',
          expandedYears: new Set(),
          expandedMonths: new Set(),
          expandedWeeks: new Set(),
          // NOV√â: pro funkci p≈ôips√°n√≠ k√°vy
          showUserSelectModal: false,
          pendingRequests: [],
          giftCoffeeCount: 1
        };

onAuthStateChanged(auth, async (user) => {
  console.log('üîÑ Auth state changed');
  if (user) {
    console.log('üë§ P≈ôihl√°≈°en jako:', user.email);
    console.log('üîë UID:', user.uid);
    
    this.state.userId = user.uid;
    this.state.userEmail = user.email;
    
    const isAdmin = user.email === ADMIN_EMAIL;
    console.log('üëë Admin check:', user.email, '===', ADMIN_EMAIL, '?', isAdmin);
    this.state.isAdmin = isAdmin;
    
    console.log('üìä Naƒç√≠t√°m data u≈æivatele...');
    await this.loadUserData(user.uid);
    
    // NOV√â: Naƒçti pending requesty
    await this.loadPendingRequests();
    
    if (this.state.view === 'login') {
      this.state.view = 'main';
    }
    
    console.log('‚úÖ Render view:', this.state.view, 'isAdmin:', this.state.isAdmin);
    this.render();
  } else {
    console.log('üö™ Odhl√°≈°en');
    this.state.view = 'login';
    this.render();
  }
});
      }

      getCurrentMonth() {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
      }

      isFirstDay() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('testFirstDay') === 'true') {
          return true;
        }
        return new Date().getDate() === 1;
      }

      formatDate(ts) {
        return new Date(ts).toLocaleString('cs-CZ', {
          day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
        });
      }

      formatDateShort(ts) {
        return new Date(ts).toLocaleDateString('cs-CZ', {
          day: '2-digit', month: '2-digit', year: 'numeric'
        });
      }

      getWeekNumber(date) {
        const d = new Date(date);
        d.setHours(0, 0, 0, 0);
        d.setDate(d.getDate() + 4 - (d.getDay() || 7));
        const yearStart = new Date(d.getFullYear(), 0, 1);
        const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return weekNo;
      }

      groupLogsByHierarchy(logs) {
        const grouped = {};
        
        logs.forEach(log => {
          const date = new Date(log.timestamp);
          const year = date.getFullYear();
          const month = `${year}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          const week = `${year}-W${String(this.getWeekNumber(date)).padStart(2, '0')}`;
          const day = date.toISOString().split('T')[0];

          if (!grouped[year]) grouped[year] = { months: {}, total: 0, count: 0 };
          if (!grouped[year].months[month]) grouped[year].months[month] = { weeks: {}, total: 0, count: 0 };
          if (!grouped[year].months[month].weeks[week]) grouped[year].months[month].weeks[week] = { days: {}, total: 0, count: 0 };
          if (!grouped[year].months[month].weeks[week].days[day]) grouped[year].months[month].weeks[week].days[day] = { logs: [], total: 0, count: 0 };

          grouped[year].months[month].weeks[week].days[day].logs.push(log);
          grouped[year].months[month].weeks[week].days[day].total += log.count * log.price;
          grouped[year].months[month].weeks[week].days[day].count += log.count;

          grouped[year].months[month].weeks[week].total += log.count * log.price;
          grouped[year].months[month].weeks[week].count += log.count;

          grouped[year].months[month].total += log.count * log.price;
          grouped[year].months[month].count += log.count;

          grouped[year].total += log.count * log.price;
          grouped[year].count += log.count;
        });

        return grouped;
      }

      toggleYear(year) {
        if (this.state.expandedYears.has(year)) {
          this.state.expandedYears.delete(year);
        } else {
          this.state.expandedYears.add(year);
        }
        this.render();
      }

      toggleMonth(month) {
        if (this.state.expandedMonths.has(month)) {
          this.state.expandedMonths.delete(month);
        } else {
          this.state.expandedMonths.add(month);
        }
        this.render();
      }

      toggleWeek(week) {
        if (this.state.expandedWeeks.has(week)) {
          this.state.expandedWeeks.delete(week);
        } else {
          this.state.expandedWeeks.add(week);
        }
        this.render();
      }

      async init() {
        this.render();
      }

      async loadUserData(userId) {
        try {
          const userData = await window.storage.get(`user_${userId}`);
          const user = userData.value;
          
          this.state.userName = user.name || '';
          this.state.coffeeCount = user.allTimeCount || 0;
          this.state.monthlyTotal = user.monthlyTotal || 0;
          
          const priceData = await window.storage.get('coffeePrice');
          this.state.coffeePrice = priceData.value || 15;
          
          try {
            const nameData = await window.storage.get('coffeeName');
            this.state.coffeeName = nameData.value || '';
          } catch (e) {
            this.state.coffeeName = '';
          }
          
          const logRes = await window.storage.list(`log_${userId}_`);
          const logs = await Promise.all(
            logRes.keys.map(async k => {
              const d = await window.storage.get(k);
              return d.value;
            })
          );
          
          this.state.allTimeLogs = logs.sort((a, b) => b.timestamp - a.timestamp);
          
          const currentMonth = this.getCurrentMonth();
          this.state.monthlyLogs = logs.filter(l => {
            const logMonth = new Date(l.timestamp).toISOString().slice(0, 7);
            return logMonth === currentMonth;
          });
          
        } catch (e) {
          console.error('Chyba p≈ôi naƒç√≠t√°n√≠ dat:', e);
        }
      }

      // NOV√â: Naƒç√≠st pending requesty pro aktu√°ln√≠ho u≈æivatele
      async loadPendingRequests() {
        try {
          const requestsRef = collection(db, 'pendingCoffeeRequests');
          const snapshot = await getDocs(requestsRef);
          
          this.state.pendingRequests = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            if (data.recipientId === this.state.userId) {
              this.state.pendingRequests.push({
                id: doc.id,
                ...data
              });
            }
          });
          
          console.log('üì¨ Naƒçteno pending request≈Ø:', this.state.pendingRequests.length);
        } catch (e) {
          console.error('Chyba p≈ôi naƒç√≠t√°n√≠ pending request≈Ø:', e);
        }
      }

      async loadUsers() {
        try {
          const usersRes = await window.storage.list('user_');
          const users = await Promise.all(
            usersRes.keys.map(async k => {
              const d = await window.storage.get(k);
              return { uid: k.replace('user_', ''), ...d.value };
            })
          );
          this.state.allUsers = users.sort((a, b) => (b.monthlyTotal || 0) - (a.monthlyTotal || 0));
        } catch (e) {
          console.error('Chyba p≈ôi naƒç√≠t√°n√≠ u≈æivatel≈Ø:', e);
        }
      }

      async userLogin() {
        const s = this.state;
        if (!s.loginEmail || !s.loginPassword) {
          alert('Vypl≈à email a heslo');
          return;
        }
        
        try {
          await signInWithEmailAndPassword(auth, s.loginEmail, s.loginPassword);
        } catch (err) {
          console.error('Login error:', err);
          alert('≈†patn√Ω email nebo heslo');
        }
      }

      async logout() {
        await signOut(auth);
      }

      async addCoffee(count) {
        const s = this.state;
        const timestamp = Date.now();
        const logKey = `log_${s.userId}_${timestamp}`;
        
        try {
          await window.storage.set(logKey, {
            count,
            price: s.coffeePrice,
            coffeeName: s.coffeeName,
            timestamp
          });
          
          const currentMonth = this.getCurrentMonth();
          
          const userRef = doc(db, 'storage', `user_${s.userId}`);
          await updateDoc(userRef, {
            allTimeCount: increment(count),
            monthlyTotal: increment(count),
            [`monthly_${currentMonth}`]: increment(count),
            value: {
              name: s.userName,
              email: s.userEmail,
              allTimeCount: s.coffeeCount + count,
              monthlyTotal: s.monthlyTotal + count
            }
          });
          
          await this.loadUserData(s.userId);
          this.render();
        } catch (e) {
          console.error('Chyba:', e);
          alert('Nepoda≈ôilo se p≈ôidat k√°vu');
        }
      }

      // NOV√â: Odeslat ≈æ√°dost o p≈ôips√°n√≠ k√°vy jin√©mu u≈æivateli
      async sendCoffeeRequest(recipientId, recipientName, count) {
        try {
          const requestId = `${this.state.userId}_${recipientId}_${Date.now()}`;
          const requestRef = doc(db, 'pendingCoffeeRequests', requestId);
          
          await setDoc(requestRef, {
            senderId: this.state.userId,
            senderName: this.state.userName,
            recipientId: recipientId,
            recipientName: recipientName,
            count: count,
            price: this.state.coffeePrice,
            coffeeName: this.state.coffeeName,
            timestamp: Date.now(),
            status: 'pending'
          });
          
          console.log('‚úÖ ≈Ω√°dost odesl√°na:', requestId);
          alert(`≈Ω√°dost o p≈ôips√°n√≠ ${count}x k√°va byla odesl√°na u≈æivateli ${recipientName}`);
          
          this.state.showUserSelectModal = false;
          this.render();
        } catch (e) {
          console.error('Chyba p≈ôi odes√≠l√°n√≠ ≈æ√°dosti:', e);
          alert('Nepoda≈ôilo se odeslat ≈æ√°dost');
        }
      }

      // NOV√â: Schv√°lit ≈æ√°dost o k√°vu
      async acceptCoffeeRequest(request) {
        try {
          const timestamp = Date.now();
          const logKey = `log_${this.state.userId}_${timestamp}`;
          
          // P≈ôidat k√°vu p≈ô√≠jemci
          await window.storage.set(logKey, {
            count: request.count,
            price: request.price,
            coffeeName: request.coffeeName,
            timestamp,
            giftFrom: request.senderName
          });
          
          const currentMonth = this.getCurrentMonth();
          const userRef = doc(db, 'storage', `user_${this.state.userId}`);
          await updateDoc(userRef, {
            allTimeCount: increment(request.count),
            monthlyTotal: increment(request.count),
            [`monthly_${currentMonth}`]: increment(request.count)
          });
          
          // Smazat request
          await deleteDoc(doc(db, 'pendingCoffeeRequests', request.id));
          
          await this.loadUserData(this.state.userId);
          await this.loadPendingRequests();
          
          alert(`K√°va p≈ôips√°na! üéâ`);
          this.render();
        } catch (e) {
          console.error('Chyba p≈ôi p≈ôij√≠m√°n√≠ ≈æ√°dosti:', e);
          alert('Nepoda≈ôilo se p≈ôijmout ≈æ√°dost');
        }
      }

      // NOV√â: Odm√≠tnout ≈æ√°dost o k√°vu (vr√°tit odes√≠lateli)
      async rejectCoffeeRequest(request) {
        try {
          const timestamp = Date.now();
          const logKey = `log_${request.senderId}_${timestamp}`;
          
          // P≈ôidat k√°vu odes√≠lateli zpƒõt
          await window.storage.set(logKey, {
            count: request.count,
            price: request.price,
            coffeeName: request.coffeeName,
            timestamp,
            returnedFrom: request.recipientName
          });
          
          const currentMonth = this.getCurrentMonth();
          const senderRef = doc(db, 'storage', `user_${request.senderId}`);
          const senderDoc = await getDoc(senderRef);
          
          if (senderDoc.exists()) {
            const senderData = senderDoc.data().value;
            await updateDoc(senderRef, {
              allTimeCount: increment(request.count),
              monthlyTotal: increment(request.count),
              [`monthly_${currentMonth}`]: increment(request.count),
              value: {
                ...senderData,
                allTimeCount: (senderData.allTimeCount || 0) + request.count,
                monthlyTotal: (senderData.monthlyTotal || 0) + request.count
              }
            });
          }
          
          // Smazat request
          await deleteDoc(doc(db, 'pendingCoffeeRequests', request.id));
          
          await this.loadPendingRequests();
          
          alert(`K√°va vr√°cena u≈æivateli ${request.senderName}`);
          this.render();
        } catch (e) {
          console.error('Chyba p≈ôi odm√≠t√°n√≠ ≈æ√°dosti:', e);
          alert('Nepoda≈ôilo se odm√≠tnout ≈æ√°dost');
        }
      }

      async confirmPayment() {
        const s = this.state;
        const amount = s.monthlyTotal * s.coffeePrice;
        const currentMonth = this.getCurrentMonth();
        
        if (!confirm(`Potvrzuje≈° √∫hradu ${amount} Kƒç za ${s.monthlyTotal} k√°v?`)) return;
        
        try {
          const userRef = doc(db, 'storage', `user_${s.userId}`);
          await updateDoc(userRef, {
            monthlyTotal: 0,
            [`monthly_${currentMonth}`]: 0,
            value: {
              name: s.userName,
              email: s.userEmail,
              allTimeCount: s.coffeeCount,
              monthlyTotal: 0
            }
          });
          
          await this.loadUserData(s.userId);
          alert('Zaplaceno! ‚úÖ');
          this.render();
        } catch (e) {
          console.error('Chyba:', e);
          alert('Nepoda≈ôilo se potvrdit platbu');
        }
      }

      async updatePrice() {
        const s = this.state;
        const newPrice = parseInt(s.newPrice);
        if (!newPrice || newPrice < 1) {
          alert('Zadej platnou cenu');
          return;
        }
        
        try {
          await window.storage.set('coffeePrice', newPrice);
          
          if (s.newCoffeeName.trim()) {
            await window.storage.set('coffeeName', s.newCoffeeName.trim());
          }
          
          await this.loadUserData(s.userId);
          alert('Ulo≈æeno! ‚úÖ');
          this.render();
        } catch (e) {
          console.error('Chyba:', e);
          alert('Nepoda≈ôilo se ulo≈æit');
        }
      }

      async createUser() {
        const s = this.state;
        if (!s.newUserName || !s.newUserEmail || !s.newUserPassword) {
          alert('Vypl≈à v≈°echna pole');
          return;
        }
        
        const uid = prompt('Vlo≈æ UID z Firebase Console:');
        if (!uid) return;
        
        try {
          await window.storage.set(`user_${uid}`, {
            name: s.newUserName,
            email: s.newUserEmail,
            allTimeCount: 0,
            monthlyTotal: 0
          });
          
          s.newUserName = '';
          s.newUserEmail = '';
          s.newUserPassword = '';
          
          await this.loadUsers();
          alert('U≈æivatel vytvo≈ôen! ‚úÖ');
          this.render();
        } catch (e) {
          console.error('Chyba:', e);
          alert('Nepoda≈ôilo se vytvo≈ôit u≈æivatele');
        }
      }

      render() {
        const s = this.state;
        const root = document.getElementById('app');
        
        let html = '';
        if (s.view === 'login') html = this.renderLogin();
        else if (s.view === 'main') html = this.renderMain();
        else if (s.view === 'alltimelog') html = this.renderAllTimeLog();
        else if (s.view === 'monthlylog') html = this.renderMonthlyLog();
        else if (s.view === 'admin') html = this.renderAdmin();
        
        // NOV√â: P≈ôidat modal pro v√Ωbƒõr u≈æivatele
        if (s.showUserSelectModal) {
          html += this.renderUserSelectModal();
        }
        
        root.innerHTML = html;
        this.attachListeners();
      }

      renderLogin() {
        return `
          <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
              <div class="text-center mb-8">
                <div class="text-6xl mb-4">‚òï</div>
                <h1 class="text-3xl font-bold text-amber-800">Coffee Tracker</h1>
              </div>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-semibold mb-2 text-gray-700">Email</label>
                  <input type="email" id="loginEmail" value="${this.state.loginEmail}" 
                    class="w-full px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500" 
                    placeholder="tvuj@email.cz">
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-2 text-gray-700">Heslo</label>
                  <input type="password" id="loginPassword" value="${this.state.loginPassword}" 
                    class="w-full px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500" 
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button id="loginBtn" class="w-full bg-amber-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-amber-700 transition">
                  P≈ôihl√°sit se
                </button>
              </div>
            </div>
          </div>
        `;
      }

      renderMain() {
        const s = this.state;
        const amount = s.monthlyTotal * s.coffeePrice;
        const isFirstDayOfMonth = this.isFirstDay();
        
        return `
          <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100">
            ${this.renderPendingRequestsBanner()}
            
            <div class="bg-white shadow-md">
              <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                <div>
                  <h1 class="text-2xl font-bold text-amber-800">Ahoj, ${s.userName}! ‚òï</h1>
                  <p class="text-sm text-gray-600">${s.userEmail}</p>
                </div>
                <button id="logoutBtn" class="text-gray-600 hover:text-gray-800 font-semibold">Odhl√°sit</button>
              </div>
            </div>

            <div class="max-w-4xl mx-auto p-4 space-y-4">
              <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="text-center mb-6">
                  <div class="text-7xl mb-2">‚òï</div>
                  ${s.coffeeName ? `<p class="text-lg font-semibold text-amber-700 mb-2">‚òï ${s.coffeeName}</p>` : ''}
                  <p class="text-5xl font-bold text-amber-800 mb-2">${s.monthlyTotal}</p>
                  <p class="text-gray-600">k√°v tento mƒõs√≠c</p>
                  <p class="text-2xl font-bold text-amber-600 mt-4">${amount} Kƒç</p>
                  <p class="text-sm text-gray-500">@ ${s.coffeePrice} Kƒç/k√°va</p>
                  <p class="text-sm text-gray-500 mt-2">Celkem: ${s.coffeeCount} k√°v</p>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                  <button id="add1" class="bg-amber-500 text-white py-4 rounded-xl font-bold text-xl hover:bg-amber-600 transition">
                    + 1 ‚òï
                  </button>
                  <button id="add2" class="bg-amber-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-amber-700 transition">
                    + 2 ‚òï
                  </button>
                </div>

                <div class="flex gap-3 mb-4">
                  <input type="number" id="custom" min="1" placeholder="Vlastn√≠ poƒçet" value="${s.customCount}"
                    class="flex-1 px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500">
                  <button id="addCustom" class="bg-amber-700 text-white px-6 py-3 rounded-xl font-bold hover:bg-amber-800 transition">
                    P≈ôidat
                  </button>
                </div>

                <button id="giftCoffee" class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 transition mb-4">
                  üéÅ Kafe pro kolegu
                </button>

                ${isFirstDayOfMonth && s.monthlyTotal > 0 ? `
                  <div class="bg-green-50 border-2 border-green-200 rounded-xl p-4 mb-4">
                    <p class="text-green-800 font-bold mb-2">üí≥ Platba za minul√Ω mƒõs√≠c</p>
                    <p class="text-green-700 mb-3">Na √∫ƒçet: <span class="font-mono font-bold">${BANK_ACCOUNT}</span></p>
                    <button id="payBtn" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700">
                      ‚úÖ Zaplatil jsem ${amount} Kƒç
                    </button>
                  </div>
                ` : ''}
              </div>

              <div class="grid grid-cols-2 gap-3">
                <button id="allLog" class="bg-white rounded-xl shadow-lg p-4 hover:shadow-xl transition">
                  <p class="text-2xl mb-1">üìä</p>
                  <p class="font-bold text-gray-800">V≈°e</p>
                  <p class="text-sm text-gray-600">${s.allTimeLogs.length} z√°znam≈Ø</p>
                </button>
                <button id="monthLog" class="bg-white rounded-xl shadow-lg p-4 hover:shadow-xl transition">
                  <p class="text-2xl mb-1">üìÖ</p>
                  <p class="font-bold text-gray-800">Tento mƒõs√≠c</p>
                  <p class="text-sm text-gray-600">${s.monthlyLogs.length} z√°znam≈Ø</p>
                </button>
              </div>

              ${s.isAdmin ? `
                <button id="adminBtn" class="w-full bg-purple-600 text-white py-4 rounded-xl font-bold hover:bg-purple-700 transition">
                  üëë Admin Panel
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }

      // NOV√â: Banner s pending requesty
      renderPendingRequestsBanner() {
        const s = this.state;
        if (s.pendingRequests.length === 0) return '';
        
        return s.pendingRequests.map(req => `
          <div class="bg-blue-50 border-b-2 border-blue-200">
            <div class="max-w-4xl mx-auto px-4 py-4">
              <div class="flex items-center justify-between gap-4">
                <div class="flex-1">
                  <p class="font-bold text-blue-900 mb-1">
                    üéÅ U≈æivatel <span class="text-blue-600">${req.senderName}</span> ti p≈ôidal ${req.count > 1 ? `${req.count} k√°vy` : 'k√°vu'}
                  </p>
                  <p class="text-sm text-blue-700">
                    ${req.coffeeName ? `‚òï ${req.coffeeName} ‚Ä¢ ` : ''}${req.count * req.price} Kƒç
                  </p>
                  <p class="text-xs text-blue-600 mt-1">
                    Potvrƒè p≈ôips√°n√≠ k√°v na tv≈Øj √∫ƒçet nebo odm√≠tni a k√°va bude p≈ôips√°na u≈æivateli ${req.senderName}
                  </p>
                </div>
                <div class="flex gap-2">
                  <button data-accept-request="${req.id}" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition whitespace-nowrap">
                    OK!
                  </button>
                  <button data-reject-request="${req.id}" class="bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition whitespace-nowrap">
                    NOT OK!
                  </button>
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }

      // NOV√â: Modal pro v√Ωbƒõr u≈æivatele
      renderUserSelectModal() {
        const s = this.state;
        
        // Naƒç√≠st v≈°echny u≈æivatele kromƒõ aktu√°ln√≠ho
        const otherUsers = s.allUsers.filter(u => u.uid !== s.userId);
        
        return `
          <div class="modal-backdrop">
            <div class="modal-content">
              <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                  <h2 class="text-xl font-bold">Vyberte u≈æivatele</h2>
                  <button id="closeModal" class="text-2xl text-gray-600 hover:text-gray-800">&times;</button>
                </div>
                
                <div class="mb-4">
                  <label class="block text-sm font-semibold mb-2">Poƒçet k√°v</label>
                  <input type="number" id="giftCount" value="${s.giftCoffeeCount}" min="1"
                    class="w-full px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500">
                </div>
                
                <div class="space-y-2 max-h-96 overflow-y-auto">
                  ${otherUsers.length > 0 ? otherUsers.map(u => `
                    <button data-select-user="${u.uid}" data-user-name="${u.name}" 
                      class="w-full text-left p-4 bg-gray-50 hover:bg-amber-50 rounded-lg transition border-2 border-transparent hover:border-amber-300">
                      <p class="font-semibold text-gray-800">${u.name}</p>
                      <p class="text-sm text-gray-600">${u.email}</p>
                    </button>
                  `).join('') : `
                    <p class="text-gray-500 text-center py-8">Naƒç√≠t√°n√≠ u≈æivatel≈Ø...</p>
                  `}
                </div>
              </div>
            </div>
          </div>
        `;
      }

      renderAllTimeLog() {
        const s = this.state;
        const grouped = this.groupLogsByHierarchy(s.allTimeLogs);
        const years = Object.keys(grouped).sort((a, b) => b - a);
        
        return `
          <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100">
            <div class="bg-white shadow-md">
              <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                  <button id="back" class="text-gray-600 hover:text-gray-800">‚óÄÔ∏è</button>
                  <h1 class="text-xl font-bold">Kompletn√≠ historie</h1>
                </div>
              </div>
            </div>
            <div class="max-w-4xl mx-auto p-4">
              <div class="bg-white rounded-2xl shadow-lg p-6">
                ${years.length > 0 ? years.map(year => {
                  const yearData = grouped[year];
                  const isExpanded = s.expandedYears.has(year);
                  const months = Object.keys(yearData.months).sort((a, b) => b.localeCompare(a));
                  
                  return `
                    <div class="mb-3">
                      <button data-toggle-year="${year}" 
                        class="w-full flex justify-between items-center p-4 bg-amber-100 hover:bg-amber-200 rounded-xl transition">
                        <span class="font-bold text-lg">${isExpanded ? '‚ñº' : '‚ñ∂'} ${year}</span>
                        <div class="text-right">
                          <p class="font-bold text-amber-700">${yearData.count} k√°v</p>
                          <p class="text-sm text-amber-600">${yearData.total} Kƒç</p>
                        </div>
                      </button>
                      
                      ${isExpanded ? `
                        <div class="ml-4 mt-2 space-y-2">
                          ${months.map(month => {
                            const monthData = yearData.months[month];
                            const isMonthExpanded = s.expandedMonths.has(month);
                            const weeks = Object.keys(monthData.weeks).sort((a, b) => b.localeCompare(a));
                            const monthName = new Date(month + '-01').toLocaleDateString('cs-CZ', { month: 'long', year: 'numeric' });
                            
                            return `
                              <div>
                                <button data-toggle-month="${month}"
                                  class="w-full flex justify-between items-center p-3 bg-amber-50 hover:bg-amber-100 rounded-lg transition">
                                  <span class="font-semibold">${isMonthExpanded ? '‚ñº' : '‚ñ∂'} ${monthName}</span>
                                  <div class="text-right">
                                    <p class="font-bold text-amber-600">${monthData.count} k√°v</p>
                                    <p class="text-xs text-amber-500">${monthData.total} Kƒç</p>
                                  </div>
                                </button>
                                
                                ${isMonthExpanded ? `
                                  <div class="ml-4 mt-2 space-y-2">
                                    ${weeks.map(week => {
                                      const weekData = monthData.weeks[week];
                                      const isWeekExpanded = s.expandedWeeks.has(week);
                                      const days = Object.keys(weekData.days).sort((a, b) => b.localeCompare(a));
                                      
                                      return `
                                        <div>
                                          <button data-toggle-week="${week}"
                                            class="w-full flex justify-between items-center p-3 bg-gray-50 hover:bg-gray-100 rounded-lg transition">
                                            <span class="text-sm font-semibold">${isWeekExpanded ? '‚ñº' : '‚ñ∂'} T√Ωden ${week.split('-W')[1]}</span>
                                            <div class="text-right">
                                              <p class="text-sm font-bold text-gray-700">${weekData.count} k√°v</p>
                                              <p class="text-xs text-gray-500">${weekData.total} Kƒç</p>
                                            </div>
                                          </button>
                                          
                                          ${isWeekExpanded ? `
                                            <div class="ml-4 mt-2 space-y-2">
                                              ${days.map(day => {
                                                const dayData = weekData.days[day];
                                                const dayName = new Date(day).toLocaleDateString('cs-CZ', { weekday: 'short', day: 'numeric', month: 'numeric' });
                                                
                                                return `
                                                  <div class="bg-white rounded-lg p-3 border-2 border-gray-100">
                                                    <div class="flex justify-between items-center mb-2">
                                                      <span class="text-sm font-semibold text-gray-700">${dayName}</span>
                                                      <div class="text-right">
                                                        <p class="text-sm font-bold text-gray-700">${dayData.count} k√°v</p>
                                                        <p class="text-xs text-gray-500">${dayData.total} Kƒç</p>
                                                      </div>
                                                    </div>
                                                    <div class="space-y-1">
                                                      ${dayData.logs.map(log => `
                                                        <div class="flex justify-between items-center text-xs p-2 bg-gray-50 rounded">
                                                          <div>
                                                            <span class="font-semibold">${log.count}x</span>
                                                            ${log.coffeeName ? `<span class="text-amber-600">‚òï ${log.coffeeName}</span>` : ''}
                                                            ${log.giftFrom ? `<span class="text-blue-600">üéÅ od ${log.giftFrom}</span>` : ''}
                                                            <span class="text-gray-500">${new Date(log.timestamp).toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit' })}</span>
                                                          </div>
                                                          <span class="font-bold text-amber-600">${log.count * log.price} Kƒç</span>
                                                        </div>
                                                      `).join('')}
                                                    </div>
                                                  </div>
                                                `;
                                              }).join('')}
                                            </div>
                                          ` : ''}
                                        </div>
                                      `;
                                    }).join('')}
                                  </div>
                                ` : ''}
                              </div>
                            `;
                          }).join('')}
                        </div>
                      ` : ''}
                    </div>
                  `;
                }).join('') : '<p class="text-gray-500 text-center py-8">≈Ω√°dn√© z√°znamy</p>'}
              </div>
            </div>
          </div>
        `;
      }

      renderMonthlyLog() {
        const s = this.state;
        return `
          <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100">
            <div class="bg-white shadow-md">
              <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                  <button id="back" class="text-gray-600 hover:text-gray-800">‚óÄÔ∏è</button>
                  <h1 class="text-xl font-bold">Tento mƒõs√≠c</h1>
                </div>
              </div>
            </div>
            <div class="max-w-4xl mx-auto p-4">
              <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="text-center mb-6">
                  <p class="text-4xl font-bold text-amber-800 mb-2">${s.monthlyTotal} k√°v</p>
                  <p class="text-2xl font-bold text-amber-600">${s.monthlyTotal * s.coffeePrice} Kƒç</p>
                </div>
                ${s.monthlyLogs.length > 0 ? `<div class="space-y-3">${s.monthlyLogs.map(log => `
                  <div class="flex justify-between items-center p-4 bg-amber-50 rounded-xl">
                    <div>
                      <p class="font-semibold">${log.count}x k√°va</p>
                      ${log.coffeeName ? `<p class="text-sm text-amber-600">‚òï ${log.coffeeName}</p>` : ''}
                      ${log.giftFrom ? `<p class="text-sm text-blue-600">üéÅ D√°rek od ${log.giftFrom}</p>` : ''}
                      <p class="text-sm text-gray-600">${this.formatDate(log.timestamp)}</p>
                    </div>
                    <div class="text-right">
                      <p class="font-bold text-amber-600">${log.count * log.price} Kƒç</p>
                      <p class="text-xs text-gray-500">${log.price} Kƒç/ks</p>
                    </div>
                  </div>
                `).join('')}</div>` : '<p class="text-gray-500 text-center py-8">≈Ω√°dn√© z√°znamy tento mƒõs√≠c</p>'}
              </div>
            </div>
          </div>
        `;
      }

      renderAdmin() {
        const s = this.state;
        return `
          <div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100">
            <div class="bg-white shadow-md">
              <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                  <button id="back" class="text-gray-600 hover:text-gray-800">‚óÄÔ∏è</button>
                  <h1 class="text-xl font-bold">Admin</h1>
                </div>
              </div>
            </div>
            <div class="max-w-4xl mx-auto p-4 space-y-4">
              <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-lg font-bold mb-4">Nastaven√≠ k√°vy</h2>
                <div class="mb-4">
                  <label class="block text-sm font-semibold mb-2">N√°zev</label>
                  <input type="text" id="newName" value="${s.newCoffeeName}" placeholder="Ethiopia..." 
                    class="w-full px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500">
                  <p class="text-xs text-gray-500 mt-1">Aktu√°ln√≠: ${s.coffeeName || 'Bez n√°zvu'}</p>
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-semibold mb-2">Cena</label>
                  <div class="flex gap-3">
                    <input type="number" id="newPrice" value="${s.newPrice}" 
                      class="flex-1 px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500">
                    <div class="flex items-center px-4 font-semibold">Kƒç</div>
                  </div>
                  <p class="text-xs text-gray-500 mt-1">Aktu√°ln√≠: ${s.coffeePrice} Kƒç</p>
                </div>
                <button id="savePrice" class="w-full bg-amber-600 text-white py-3 rounded-xl font-semibold hover:bg-amber-700">Ulo≈æit</button>
              </div>
              
              <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="text-lg font-bold mb-4">Vytvo≈ôit u≈æivatele</h2>
                <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-3 mb-4 text-sm">
                  <p class="font-bold text-yellow-800 mb-1">‚ö†Ô∏è Postup:</p>
                  <ol class="text-yellow-700 list-decimal ml-4 space-y-1">
                    <li>Vypl≈à √∫daje n√≠≈æe</li>
                    <li>Vytvo≈ô u≈æivatele v Firebase Console (Authentication ‚Üí Add user)</li>
                    <li>Zkop√≠ruj UID z Firebase</li>
                    <li>Klikni "Vytvo≈ôit" a vlo≈æ UID</li>
                  </ol>
                </div>
                <div class="mb-3">
                  <label class="block text-sm font-semibold mb-2">Jm√©no</label>
                  <input type="text" id="newUserName" value="${s.newUserName}" placeholder="Jan Nov√°k" 
                    class="w-full px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500">
                </div>
                <div class="mb-3">
                  <label class="block text-sm font-semibold mb-2">Email</label>
                  <input type="email" id="newUserEmail" value="${s.newUserEmail}" placeholder="jan@firma.cz" 
                    class="w-full px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500">
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-semibold mb-2">Heslo</label>
                  <input type="text" id="newUserPassword" value="${s.newUserPassword}" placeholder="Siln√© heslo" 
                    class="w-full px-4 py-3 border-2 rounded-xl text-lg outline-none focus:border-amber-500">
                </div>
                <button id="createUser" class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700">‚ûï Vytvo≈ôit</button>
              </div>

              <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                  <h2 class="text-lg font-bold">U≈æivatel√©</h2>
                  <button id="refresh" class="text-sm text-blue-600 hover:text-blue-700 font-semibold">Obnovit</button>
                </div>
                ${s.allUsers.length > 0 ? `<div class="space-y-2">${s.allUsers.map(u => `
                  <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div>
                      <p class="font-semibold">${u.name}</p>
                      <p class="text-xs text-gray-500">${u.email}</p>
                      <p class="text-sm text-gray-600">Mƒõs√≠c: ${u.monthlyTotal} k√°v</p>
                    </div>
                    <div class="text-right">
                      <p class="font-bold text-amber-600">${u.monthlyTotal * s.coffeePrice} Kƒç</p>
                      <p class="text-xs text-gray-500">Celkem: ${u.allTimeCount}</p>
                    </div>
                  </div>
                `).join('')}</div>` : '<p class="text-gray-500 text-center py-4">≈Ω√°dn√≠ u≈æivatel√©</p>'}
              </div>
            </div>
          </div>
        `;
      }

      attachListeners() {
        const s = this.state;
        
        if (s.view === 'login') {
          const emailInput = document.getElementById('loginEmail');
          const passInput = document.getElementById('loginPassword');
          const loginBtn = document.getElementById('loginBtn');

          emailInput?.addEventListener('input', e => s.loginEmail = e.target.value);
          passInput?.addEventListener('input', e => s.loginPassword = e.target.value);
          passInput?.addEventListener('keypress', e => {
            if (e.key === 'Enter') this.userLogin();
          });
          loginBtn?.addEventListener('click', () => this.userLogin());
        }

        if (s.view === 'main') {
          document.getElementById('logoutBtn')?.addEventListener('click', () => {
            if (confirm('Odhl√°sit?')) this.logout();
          });
          document.getElementById('allLog')?.addEventListener('click', () => { s.view = 'alltimelog'; this.render(); });
          document.getElementById('monthLog')?.addEventListener('click', () => { s.view = 'monthlylog'; this.render(); });
          document.getElementById('add1')?.addEventListener('click', () => this.addCoffee(1));
          document.getElementById('add2')?.addEventListener('click', () => this.addCoffee(2));
          document.getElementById('addCustom')?.addEventListener('click', () => {
            const val = parseInt(document.getElementById('custom').value);
            if (val > 0) this.addCoffee(val);
          });
          document.getElementById('payBtn')?.addEventListener('click', () => this.confirmPayment());
          document.getElementById('adminBtn')?.addEventListener('click', () => { 
            s.view = 'admin'; 
            this.loadUsers().then(() => this.render());
          });

          // NOV√â: Tlaƒç√≠tko pro otev≈ôen√≠ modalu
          document.getElementById('giftCoffee')?.addEventListener('click', async () => {
            await this.loadUsers();
            s.showUserSelectModal = true;
            this.render();
          });

          // NOV√â: Tlaƒç√≠tka pro p≈ôij√≠m√°n√≠/odm√≠t√°n√≠ request≈Ø
          document.querySelectorAll('[data-accept-request]').forEach(btn => {
            btn.addEventListener('click', () => {
              const requestId = btn.dataset.acceptRequest;
              const request = s.pendingRequests.find(r => r.id === requestId);
              if (request) this.acceptCoffeeRequest(request);
            });
          });

          document.querySelectorAll('[data-reject-request]').forEach(btn => {
            btn.addEventListener('click', () => {
              const requestId = btn.dataset.rejectRequest;
              const request = s.pendingRequests.find(r => r.id === requestId);
              if (request) this.rejectCoffeeRequest(request);
            });
          });
        }

        // NOV√â: Event listenery pro modal
        if (s.showUserSelectModal) {
          document.getElementById('closeModal')?.addEventListener('click', () => {
            s.showUserSelectModal = false;
            this.render();
          });

          document.getElementById('giftCount')?.addEventListener('input', (e) => {
            s.giftCoffeeCount = parseInt(e.target.value) || 1;
          });

          document.querySelectorAll('[data-select-user]').forEach(btn => {
            btn.addEventListener('click', () => {
              const userId = btn.dataset.selectUser;
              const userName = btn.dataset.userName;
              const count = parseInt(document.getElementById('giftCount').value) || 1;
              
              if (confirm(`P≈ôidat ${count}x k√°va pro u≈æivatele ${userName}?`)) {
                this.sendCoffeeRequest(userId, userName, count);
              }
            });
          });
        }

        if (s.view === 'alltimelog') {
          document.getElementById('back')?.addEventListener('click', () => { s.view = 'main'; this.render(); });
          
          document.querySelectorAll('[data-toggle-year]').forEach(btn => {
            btn.addEventListener('click', () => this.toggleYear(btn.dataset.toggleYear));
          });
          
          document.querySelectorAll('[data-toggle-month]').forEach(btn => {
            btn.addEventListener('click', () => this.toggleMonth(btn.dataset.toggleMonth));
          });
          
          document.querySelectorAll('[data-toggle-week]').forEach(btn => {
            btn.addEventListener('click', () => this.toggleWeek(btn.dataset.toggleWeek));
          });
        }

        if (s.view === 'monthlylog') {
          document.getElementById('back')?.addEventListener('click', () => { s.view = 'main'; this.render(); });
        }

        if (s.view === 'admin') {
          document.getElementById('back')?.addEventListener('click', () => { s.view = 'main'; this.render(); });
          document.getElementById('newName')?.addEventListener('input', e => s.newCoffeeName = e.target.value);
          document.getElementById('newPrice')?.addEventListener('input', e => s.newPrice = e.target.value);
          document.getElementById('savePrice')?.addEventListener('click', () => this.updatePrice());
          document.getElementById('newUserName')?.addEventListener('input', e => s.newUserName = e.target.value);
          document.getElementById('newUserEmail')?.addEventListener('input', e => s.newUserEmail = e.target.value);
          document.getElementById('newUserPassword')?.addEventListener('input', e => s.newUserPassword = e.target.value);
          document.getElementById('createUser')?.addEventListener('click', () => this.createUser());
          document.getElementById('refresh')?.addEventListener('click', () => this.loadUsers().then(() => this.render()));
        }
      }
    }

    const coffeeApp = new CoffeeApp();
    coffeeApp.init();
  </script>
</body>
</html>
